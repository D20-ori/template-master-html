<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Bilan 2025 - Version Finale</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #8b5cf6;
            --accent-color: #ec4899;
            --background-light: #f3f4f6;
            --text-light: #111827;
            --background-dark: #1f2937;
            --text-dark: #f9fafb;
        }

        body {
            transition: background-color 0.3s ease, color 0.3s ease; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }

        .tab-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: black !important;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .tab-button.active::after, .tab-button:hover::after {
            width: 100%;
        }

        .tab-button.active {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white !important;
        }

        /* Mode sombre pour les boutons d'onglets */
        .dark-mode .tab-button {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .tab-button.active {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white !important;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }

        .button-primary {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .button-secondary {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .button-primary:hover, .button-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.25s, opacity 0.25s 0s;
        }

        .popup.active {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }

        .popup-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .dark-mode .popup-content {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }

        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Popup spécifique pour les détails des graphiques */
        .chart-detail-popup .popup-content {
            max-width: 1200px;
        }

        .chart-detail-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        .chart-detail-left {
            display: flex;
            flex-direction: column;
        }

        .chart-detail-right {
            display: flex;
            flex-direction: column;
        }

        .detail-chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .detail-list {
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .dark-mode .detail-list {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .detail-item {
            padding: 0.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark-mode .detail-item {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .calendar-detail {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 1rem;
        }

        .calendar-day-detail {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 0.75rem;
            position: relative;
            cursor: pointer;
        }

        .calendar-day-detail.has-articles {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .calendar-day-detail.empty {
            background-color: #f3f4f6;
            color: #9ca3af;
        }

        .calendar-day-detail:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .calendar-month-header {
            text-align: center;
            font-weight: bold;
            margin: 1rem 0;
            padding: 0.5rem;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 8px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dark-mode .comparison-table th,
        .dark-mode .comparison-table td {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .comparison-table th {
            background-color: rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }

        .dark-mode .comparison-table th {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }

        .trend-up {
            color: #10b981;
        }

        .trend-down {
            color: #ef4444;
        }

        .trend-stable {
            color: #6b7280;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        /* Amélioration pour le mode sombre - contenu des tableaux en noir */
        table tbody td {
            color: black !important;
        }

        .dark-mode table tbody td {
            color: black !important;
            background-color: white;
        }

        /* En-têtes de tableaux en mode sombre */
        .dark-mode table thead th {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.1);
        }

        th {
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }

        th::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }

        th.sort-asc::after {
            border-bottom: 5px solid currentColor;
            border-top: none;
        }

        th.sort-desc::after {
            border-top: 5px solid currentColor;
            border-bottom: none;
        }

        tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dark-mode tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .stat-card {
            position: relative;
            border-radius: 12px;
            padding: 1.5rem;
            overflow: hidden;
            height: 100%;
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            z-index: 1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .stat-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
            z-index: 2;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 1));
            transition: width 0.5s ease;
        }

        .calendar-picker {
            position: relative;
        }

        .calendar-popup {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 10;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 1rem;
            display: none;
        }
        
        .dark-mode .calendar-popup {
            background-color: var(--background-dark);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .calendar-day {
            padding: 5px;
            cursor: pointer;
            border-radius: 4px;
        }

        .calendar-day:hover {
            background-color: rgba(79, 70, 229, 0.1);
        }

        .calendar-day.selected {
            background-color: var(--primary-color);
            color: white;
        }

        .form-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }

        .dark-mode .form-input {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 1rem;
            min-height: 500px;
        }

        .settings-container .setting-item {
            padding: 1.5rem;
            border-radius: 12px;
            background-color: white;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .settings-container .setting-item {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .top-bar {
            position: relative;
            top: auto;
            z-index: auto;
            background-color: inherit;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .year-selector select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
        }

        .dark-mode .year-selector select {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .year-actions {
            display: flex;
            gap: 0.5rem;
        }

        .year-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .export-json-container {
            position: relative;
            z-index: 1000;
        }

        .export-json-button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
            background-size: 300% 300%;
            animation: gradientShift 3s ease infinite, pulse 2s ease-in-out infinite alternate;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .export-json-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .export-json-button:hover::before {
            left: 100%;
        }

        .export-json-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .export-json-button:active {
            transform: translateY(0) scale(0.98);
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }
            100% {
                box-shadow: 0 4px 25px rgba(255, 107, 107, 0.4);
            }
        }

        .dark-mode .export-json-button {
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .export-json-button:hover {
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
            }
            
            .chart-detail-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(6, 1fr);
            }
            
            .chart-detail-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="toast" id="toast">
<div id="toast-message"></div>
</div>
<div class="container mx-auto px-4 py-4">
<div class="top-bar mb-8 pb-4">
<div class="flex justify-between items-center mb-6">
<h1 class="text-3xl font-bold" id="main-title">Bilan 2025</h1>

<!-- Export JSON déplacé ici -->
<div class="export-json-container">
<button class="export-json-button" id="export-json-button">
<i class="fas fa-download mr-2"></i>
<span>Export JSON</span>
</button>
</div>

<div class="flex items-center">
<div class="mr-4 text-sm">
<span>Dernier export JSON: </span>
<span class="font-semibold" id="last-save-time">Jamais</span>
</div>
<button class="text-black p-2 rounded-full bg-gray-200 hover:bg-gray-300" id="settings-button">
<i class="fas fa-cog"></i>
</button>
</div>
</div>
<div class="flex overflow-x-auto space-x-2 mb-4">
<button class="tab-button active px-4 py-2 font-medium rounded-t-lg" data-tab="dashboard">Tableau de bord</button>
<button class="tab-button px-4 py-2 font-medium rounded-t-lg" data-tab="nouveautes">Nouveautés</button>
<button class="tab-button px-4 py-2 font-medium rounded-t-lg" data-tab="evolutions">Évolutions</button>
<button class="tab-button px-4 py-2 font-medium rounded-t-lg" data-tab="diversifications">Diversifications</button>
</div>
</div>
<div class="bg-white p-6 rounded-lg shadow-md" id="tab-content">
<!-- Dashboard Tab -->
<div class="tab-pane active" id="dashboard">
<!-- Sélecteur d'année -->
<div class="year-selector">
<label for="year-select" class="text-lg font-semibold">Année</label>
<select id="year-select" class="form-input w-48">
<option value="2025">2025</option>
<option value="all">Toutes les années</option>
</select>
<div class="year-actions">
<button class="button-secondary" id="create-year-btn">
<i class="fas fa-plus mr-1"></i>Nouvelle année
</button>
<button class="button-secondary" id="delete-year-btn">
<i class="fas fa-trash mr-1"></i>Supprimer
</button>
</div>
</div>

<div class="mt-4 flex gap-4">
<input accept=".json" class="hidden" id="import-json-file" type="file"/>
<button class="button-secondary" id="import-json-button">
<i class="fas fa-file-import mr-2"></i>Import JSON rempli
</button>
</div>

<h2 class="text-2xl font-bold mb-6 mt-6">Tableau de bord</h2>
<div class="dashboard-grid">
<!-- Répartition des articles -->
<div class="card bg-white p-6 shadow-lg" data-chart-type="distribution">
<h3 class="text-lg font-semibold mb-4">Répartition des articles</h3>
<div class="chart-container">
<canvas id="distribution-chart"></canvas>
</div>
</div>
<!-- Activité mensuelle -->
<div class="card bg-white p-6 shadow-lg" data-chart-type="monthly">
<h3 class="text-lg font-semibold mb-4">Articles par mois et type</h3>
<div class="chart-container">
<canvas id="monthly-chart"></canvas>
</div>
</div>
<!-- Statistiques générales -->
<div class="card bg-gradient-to-r from-blue-500 to-blue-700 text-white p-6 shadow-lg stat-card" data-chart-type="general-stats">
<h3 class="text-lg font-semibold mb-4">Statistiques générales</h3>
<div class="grid grid-cols-2 gap-4">
<div class="text-center">
<div class="stat-value text-lg" id="total-designers">0</div>
<div class="stat-label text-sm">Concepteurs</div>
</div>
<div class="text-center">
<div class="stat-value text-lg" id="total-implanters">0</div>
<div class="stat-label text-sm">Implanteurs</div>
</div>
</div>
</div>
<!-- Nombre total d'articles -->
<div class="card bg-gradient-to-r from-green-500 to-green-700 text-white p-6 shadow-lg stat-card" data-chart-type="total-articles">
<h3 class="text-lg font-semibold mb-4">Nombre total d'articles</h3>
<div class="stat-value" id="total-articles-simple">0</div>
<div class="stat-label">articles enregistrés</div>
</div>
<!-- Top implanteurs -->
<div class="card bg-white p-6 shadow-lg" data-chart-type="top-implanters">
<h3 class="text-lg font-semibold mb-4">Top implanteurs</h3>
<div class="chart-container">
<canvas id="activity-chart"></canvas>
</div>
</div>
<!-- Top concepteurs -->
<div class="card bg-white p-6 shadow-lg" data-chart-type="top-designers">
<h3 class="text-lg font-semibold mb-4">Top concepteurs</h3>
<div class="chart-container">
<canvas id="contributors-chart"></canvas>
</div>
</div>
</div>
</div>
<!-- Nouveautés Tab -->
<div class="tab-pane hidden" id="nouveautes">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">Nouveaux design avec prises de numéros</h2>
<button class="button-primary" id="add-nouveaute">
<i class="fas fa-plus mr-2"></i>Ajouter
</button>
</div>
<div class="overflow-x-auto">
<table class="min-w-full" id="nouveautes-table">
<thead>
<tr class="bg-gray-200 text-gray-700">
<th class="py-3 px-4 text-left" data-sort="dateCreation">Date de création</th>
<th class="py-3 px-4 text-left" data-sort="dateSchemaReview">Date de revue de schéma</th>
<th class="py-3 px-4 text-left" data-sort="dateImplantationReview">Date de revue d'implantation</th>
<th class="py-3 px-4 text-left" data-sort="datePLM">Date de mise sous PLM</th>
<th class="py-3 px-4 text-left" data-sort="name">Nom de l'article</th>
<th class="py-3 px-4 text-left" data-sort="number">Numéro d'article</th>
<th class="py-3 px-4 text-left" data-sort="type">Type</th>
<th class="py-3 px-4 text-left" data-sort="frontDesigner">Concepteur FrontEnd</th>
<th class="py-3 px-4 text-left" data-sort="backImplanter">Implanteur BackEnd</th>
<th class="py-3 px-4 text-left" data-sort="comments">Commentaires</th>
<th class="py-3 px-4 text-center">Actions</th>
</tr>
</thead>
<tbody>
<!-- Les données sont injectées dynamiquement via JavaScript -->
</tbody>
</table>
</div>
</div>
<!-- Évolutions Tab -->
<div class="tab-pane hidden" id="evolutions">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">Évolution et modification de dossiers</h2>
<button class="button-primary" id="add-evolution">
<i class="fas fa-plus mr-2"></i>Ajouter
</button>
</div>
<div class="overflow-x-auto">
<table class="min-w-full" id="evolutions-table">
<thead>
<tr class="bg-gray-200 text-gray-700">
<th class="py-3 px-4 text-left" data-sort="dateCreation">Date de création</th>
<th class="py-3 px-4 text-left" data-sort="dateSchemaReview">Date de revue de schéma</th>
<th class="py-3 px-4 text-left" data-sort="dateImplantationReview">Date de revue d'implantation</th>
<th class="py-3 px-4 text-left" data-sort="datePLM">Date de mise sous PLM</th>
<th class="py-3 px-4 text-left" data-sort="name">Nom de l'article</th>
<th class="py-3 px-4 text-left" data-sort="number">Numéro d'article</th>
<th class="py-3 px-4 text-left" data-sort="type">Type</th>
<th class="py-3 px-4 text-left" data-sort="frontDesigner">Concepteur FrontEnd</th>
<th class="py-3 px-4 text-left" data-sort="backImplanter">Implanteur BackEnd</th>
<th class="py-3 px-4 text-left" data-sort="comments">Commentaires</th>
<th class="py-3 px-4 text-center">Actions</th>
</tr>
</thead>
<tbody>
<!-- Les données sont injectées dynamiquement via JavaScript -->
</tbody>
</table>
</div>
</div>
<!-- Diversifications Tab -->
<div class="tab-pane hidden" id="diversifications">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">Nouveaux design avec numéros déjà existants</h2>
<button class="button-primary" id="add-diversification">
<i class="fas fa-plus mr-2"></i>Ajouter
</button>
</div>
<div class="overflow-x-auto">
<table class="min-w-full" id="diversifications-table">
<thead>
<tr class="bg-gray-200 text-gray-700">
<th class="py-3 px-4 text-left" data-sort="dateCreation">Date de création</th>
<th class="py-3 px-4 text-left" data-sort="dateSchemaReview">Date de revue de schéma</th>
<th class="py-3 px-4 text-left" data-sort="dateImplantationReview">Date de revue d'implantation</th>
<th class="py-3 px-4 text-left" data-sort="datePLM">Date de mise sous PLM</th>
<th class="py-3 px-4 text-left" data-sort="name">Nom de l'article</th>
<th class="py-3 px-4 text-left" data-sort="number">Numéro d'article</th>
<th class="py-3 px-4 text-left" data-sort="type">Type</th>
<th class="py-3 px-4 text-left" data-sort="frontDesigner">Concepteur FrontEnd</th>
<th class="py-3 px-4 text-left" data-sort="backImplanter">Implanteur BackEnd</th>
<th class="py-3 px-4 text-left" data-sort="comments">Commentaires</th>
<th class="py-3 px-4 text-center">Actions</th>
</tr>
</thead>
<tbody>
<!-- Les données sont injectées dynamiquement via JavaScript -->
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Popup Formulaire -->
<div class="popup" id="item-popup">
<div class="popup-content">
<span class="close-button" id="close-popup">×</span>
<h2 class="text-2xl font-bold mb-6" id="popup-title">Ajouter un nouvel article</h2>
<form class="grid grid-cols-1 md:grid-cols-2 gap-6" id="item-form">
<input id="form-id" type="hidden"/>
<input id="form-category" type="hidden"/>
<div class="form-group">
<label class="block mb-2" for="form-date-creation">Date de création</label>
<div class="calendar-picker">
<input class="form-input" id="form-date-creation" placeholder="JJ/MM/AAAA" readonly="" type="text"/>
<div class="calendar-popup" id="calendar-date-creation"></div>
</div>
</div>
<div class="form-group">
<label class="block mb-2" for="form-date-schema-review">Date de revue de schéma</label>
<div class="calendar-picker">
<input class="form-input" id="form-date-schema-review" placeholder="JJ/MM/AAAA" readonly="" type="text"/>
<div class="calendar-popup" id="calendar-date-schema-review"></div>
</div>
</div>
<div class="form-group">
<label class="block mb-2" for="form-date-implantation-review">Date de revue d'implantation</label>
<div class="calendar-picker">
<input class="form-input" id="form-date-implantation-review" placeholder="JJ/MM/AAAA" readonly="" type="text"/>
<div class="calendar-popup" id="calendar-date-implantation-review"></div>
</div>
</div>
<div class="form-group">
<label class="block mb-2" for="form-date-plm">Date de mise sous PLM</label>
<div class="calendar-picker">
<input class="form-input" id="form-date-plm" placeholder="JJ/MM/AAAA" readonly="" type="text"/>
<div class="calendar-popup" id="calendar-date-plm"></div>
</div>
</div>
<div class="form-group">
<label class="block mb-2" for="form-name">Nom de l'article</label>
<input class="form-input" id="form-name" placeholder="Nom de l'article" type="text"/>
</div>
<div class="form-group">
<label class="block mb-2" for="form-number">Numéro d'article</label>
<input class="form-input" id="form-number" placeholder="Numéro d'article" type="text"/>
</div>
<div class="form-group">
<label class="block mb-2" for="form-type">Type</label>
<select class="form-input" id="form-type">
<option value="Maquette">Maquette</option>
<option value="Produit">Produit</option>
</select>
</div>
<div class="form-group">
<label class="block mb-2" for="form-front-designer">Concepteur FrontEnd</label>
<input class="form-input" id="form-front-designer" placeholder="Concepteur FrontEnd" type="text"/>
</div>
<div class="form-group">
<label class="block mb-2" for="form-back-implanter">Implanteur BackEnd</label>
<input class="form-input" id="form-back-implanter" placeholder="Implanteur BackEnd" type="text"/>
</div>
<div class="form-group md:col-span-2">
<label class="block mb-2" for="form-comments">Commentaires</label>
<textarea class="form-input" id="form-comments" placeholder="Commentaires" rows="3"></textarea>
</div>
<div class="md:col-span-2 flex justify-end mt-4">
<button class="button-secondary mr-4" id="cancel-form" type="button">Annuler</button>
<button class="button-primary" id="save-form" type="submit">Sauvegarder</button>
</div>
</form>
</div>
</div>

<!-- Popup Détails des Graphiques -->
<div class="popup chart-detail-popup" id="chart-detail-popup">
<div class="popup-content">
<span class="close-button" id="close-chart-detail">×</span>
<h2 class="text-2xl font-bold mb-4" id="chart-detail-title">Détails du graphique</h2>
<div class="chart-detail-container" id="chart-detail-container">
<!-- Le contenu sera généré dynamiquement -->
</div>
</div>
</div>

<!-- Popup Réglages -->
<div class="popup" id="settings-popup">
<div class="popup-content">
<span class="close-button" id="close-settings">×</span>
<h2 class="text-2xl font-bold mb-6">Réglages</h2>
<div class="settings-container">
<div class="setting-item">
<h3 class="text-lg font-semibold mb-4">Apparence</h3>
<div class="flex items-center">
<label class="inline-flex items-center cursor-pointer">
<input class="sr-only peer" id="dark-mode-toggle" type="checkbox"/>
<div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
<span class="ml-3 text-sm font-medium">Mode sombre</span>
</label>
</div>
</div>
<div class="setting-item">
<h3 class="text-lg font-semibold mb-4">Exportation</h3>
<button class="button-primary mb-4 w-full" id="export-pdf">
<i class="fas fa-file-pdf mr-2"></i>Exporter en PDF
</button>
<button class="button-secondary w-full" id="export-excel">
<i class="fas fa-file-excel mr-2"></i>Exporter en Excel
</button>
</div>
</div>
</div>
</div>

<!-- Popup de confirmation pour la suppression -->
<div class="popup" id="confirmation-popup">
<div class="popup-content" style="max-width: 400px;">
<h2 class="text-xl font-bold mb-4">Confirmation</h2>
<p class="mb-6">Êtes-vous sûr de vouloir supprimer cet élément ? Cette action est irréversible.</p>
<div class="flex justify-end">
<button class="button-secondary mr-4" id="cancel-delete">Annuler</button>
<button class="button-primary bg-red-600 hover:bg-red-700" id="confirm-delete">Supprimer</button>
</div>
</div>
</div>

<!-- Popup pour créer une nouvelle année -->
<div class="popup" id="create-year-popup">
<div class="popup-content" style="max-width: 400px;">
<span class="close-button" id="close-create-year">×</span>
<h2 class="text-xl font-bold mb-4">Créer une nouvelle année</h2>
<div class="mb-4">
<label class="block mb-2" for="new-year-input">Année</label>
<input class="form-input" id="new-year-input" placeholder="2026" type="number" min="2020" max="2050"/>
</div>
<div class="flex justify-end">
<button class="button-secondary mr-4" id="cancel-create-year">Annuler</button>
<button class="button-primary" id="confirm-create-year">Créer</button>
</div>
</div>
</div>

<!-- Popup pour sélectionner l'année d'import -->
<div class="popup" id="import-year-popup">
<div class="popup-content" style="max-width: 500px;">
<span class="close-button" id="close-import-year">×</span>
<h2 class="text-xl font-bold mb-4">Importer dans quelle année ?</h2>
<div class="mb-4">
<p class="mb-3 text-gray-600">Sélectionnez l'année dans laquelle vous souhaitez importer les données :</p>
<div class="mb-3">
<label class="block mb-2" for="import-year-select">Année de destination :</label>
<select class="form-input" id="import-year-select">
<!-- Options générées dynamiquement -->
</select>
</div>
<div class="text-sm text-gray-500">
<p><strong>Années disponibles :</strong> <span id="available-years-list"></span></p>
</div>
</div>
<div class="flex justify-end">
<button class="button-secondary mr-4" id="cancel-import-year">Annuler</button>
<button class="button-primary" id="confirm-import-year">Importer</button>
</div>
</div>
</div>

<script>
        // État global de l'application
        const state = {
            currentYear: '2025',
            availableYears: ['2025'],
            data: {
                '2025': {
                    nouveautes: [],
                    evolutions: [],
                    diversifications: []
                }
            },
            currentCategory: null,
            deleteItemId: null,
            deleteYear: null,
            darkMode: false,
            sortColumn: null,
            sortDirection: 'asc',
            charts: {},
            currentCalendarDate: {},
            pendingImportData: null,
            lastFormValues: {},
            chartDetailPopupOpen: false
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initYearManagement();
            initTabs();
            initPopups();
            initForms();
            initCalendars();
            initCharts();
            initSettings();
            initTableSort();
            initChartClickHandlers();
            updateDashboard();

            // Afficher l'heure de la dernière sauvegarde JSON (priorité) ou sauvegarde normale
            const lastJsonExport = localStorage.getItem('lastJsonExportTime');
            const lastSave = localStorage.getItem('lastSaveTime');

            if (lastJsonExport) {
                document.getElementById('last-save-time').textContent = new Date(parseInt(lastJsonExport)).toLocaleString();
            } else if (lastSave) {
                document.getElementById('last-save-time').textContent = new Date(parseInt(lastSave)).toLocaleString();
            }
        });

        // Fonction pour initialiser les gestionnaires de clic sur les graphiques
        function initChartClickHandlers() {
            // Ajouter des événements de clic sur toutes les cartes avec data-chart-type
            document.querySelectorAll('.card[data-chart-type]').forEach(card => {
                card.addEventListener('click', (event) => {
                    // Empêcher la propagation si on clique sur un élément interactif
                    if (event.target.closest('button, input, select, textarea')) {
                        return;
                    }
                    
                    const chartType = card.getAttribute('data-chart-type');
                    openChartDetailPopup(chartType);
                });
            });

            // Fermeture de la popup de détails
            document.getElementById('close-chart-detail').addEventListener('click', () => {
                document.getElementById('chart-detail-popup').classList.remove('active');
                state.chartDetailPopupOpen = false;
            });

            // Fermer en cliquant en dehors
            document.getElementById('chart-detail-popup').addEventListener('click', (event) => {
                if (event.target.id === 'chart-detail-popup') {
                    document.getElementById('chart-detail-popup').classList.remove('active');
                    state.chartDetailPopupOpen = false;
                }
            });
        }

        // Fonction pour ouvrir la popup de détails d'un graphique (CORRIGÉE)
		function openChartDetailPopup(chartType) {
			const popup = document.getElementById('chart-detail-popup');
			const title = document.getElementById('chart-detail-title');
			const container = document.getElementById('chart-detail-container');

			// Définir le titre selon le type de graphique
			const titles = {
				'distribution': 'Répartition détaillée des articles',
				'monthly': 'Calendrier détaillé des articles par mois',
				'general-stats': 'Statistiques générales détaillées',
				'total-articles': 'Liste détaillée de tous les articles',
				'top-implanters': 'Tous les implanteurs et leurs projets',
				'top-designers': 'Tous les concepteurs et leurs projets'
			};

			title.textContent = titles[chartType] || 'Détails du graphique';

			// Générer le contenu selon le type
			container.innerHTML = generateChartDetailContent(chartType);

			// Afficher la popup
			popup.classList.add('active');
			state.chartDetailPopupOpen = true;

			// Initialiser les graphiques détaillés avec un délai plus long
			setTimeout(() => {
				initDetailCharts(chartType);
			}, 200); // Augmenté de 100ms à 200ms
		}

        // Fonction pour générer le contenu détaillé d'un graphique
        function generateChartDetailContent(chartType) {
            const currentData = getCurrentYearData();
            const allItems = [...currentData.nouveautes, ...currentData.evolutions, ...currentData.diversifications];

            switch (chartType) {
                case 'distribution':
                    return generateDistributionDetailContent(currentData);
                case 'monthly':
                    return generateMonthlyDetailContent(currentData, allItems);
                case 'general-stats':
                    return generateGeneralStatsDetailContent(allItems);
                case 'total-articles':
                    return generateTotalArticlesDetailContent(allItems);
                case 'top-implanters':
                    return generateTopImplantersDetailContent(allItems);
                case 'top-designers':
                    return generateTopDesignersDetailContent(allItems);
                default:
                    return '<p>Détails non disponibles pour ce graphique.</p>';
            }
        }

        // Fonction pour générer le contenu détaillé de la répartition
        function generateDistributionDetailContent(currentData) {
            const nouveautesCount = currentData.nouveautes.length;
            const evolutionsCount = currentData.evolutions.length;
            const diversificationsCount = currentData.diversifications.length;
            const total = nouveautesCount + evolutionsCount + diversificationsCount;

            let content = `
                <div class="chart-detail-left">
                    <div class="detail-chart-container">
                        <canvas id="detail-distribution-chart"></canvas>
                    </div>
                    <div class="statistics-grid">
                        <div class="stat-item">
                            <span class="stat-number">${nouveautesCount}</span>
                            <span class="stat-label">Nouveautés</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${evolutionsCount}</span>
                            <span class="stat-label">Évolutions</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${diversificationsCount}</span>
                            <span class="stat-label">Diversifications</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${total}</span>
                            <span class="stat-label">Total</span>
                        </div>
                    </div>
                </div>
                <div class="chart-detail-right">
                    <h4 class="text-lg font-semibold mb-3">Détails par catégorie</h4>
            `;

            if (state.currentYear === 'all') {
                // Mode toutes les années - comparaison par année
                content += generateYearlyComparisonTable();
            } else {
                // Mode année unique - détails par catégorie
                content += `
                    <div class="detail-list">
                        <h5 class="font-semibold mb-2 text-blue-600">Nouveautés (${nouveautesCount})</h5>
                        ${generateCategoryItemsList(currentData.nouveautes)}
                        
                        <h5 class="font-semibold mb-2 mt-4 text-red-600">Évolutions (${evolutionsCount})</h5>
                        ${generateCategoryItemsList(currentData.evolutions)}
                        
                        <h5 class="font-semibold mb-2 mt-4 text-green-600">Diversifications (${diversificationsCount})</h5>
                        ${generateCategoryItemsList(currentData.diversifications)}
                    </div>
                `;
            }

            content += `
                </div>
            `;

            return content;
        }

        // Fonction pour générer le contenu détaillé mensuel
        function generateMonthlyDetailContent(currentData, allItems) {
            const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                          'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

            let content = `
                <div class="chart-detail-left">
                    <div class="detail-chart-container">
                        <canvas id="detail-monthly-chart"></canvas>
                    </div>
                </div>
                <div class="chart-detail-right">
                    <h4 class="text-lg font-semibold mb-3">Calendrier détaillé</h4>
                    <div class="detail-list">
            `;

            // Organiser les articles par mois
            const articlesByMonth = {};
            months.forEach((month, index) => {
                articlesByMonth[index] = [];
            });

            allItems.forEach(item => {
                if (item.dateCreation) {
                    const date = parseDate(item.dateCreation);
                    if (date) {
                        const month = date.getMonth();
                        articlesByMonth[month].push(item);
                    }
                }
            });

            // Afficher les articles par mois
            months.forEach((month, index) => {
                const monthItems = articlesByMonth[index];
                content += `
                    <div class="calendar-month-header">${month} (${monthItems.length} articles)</div>
                `;

                if (monthItems.length > 0) {
                    monthItems.forEach(item => {
                        const itemDate = parseDate(item.dateCreation);
                        const day = itemDate ? itemDate.getDate() : '?';
                        content += `
                            <div class="detail-item">
                                <div>
                                    <strong>${day} ${month}</strong> - ${item.name || 'Sans nom'} 
                                    <span class="text-sm text-gray-600">(${item.type || 'Maquette'})</span>
                                </div>
                                <div class="text-sm">
                                    <div>Concepteur: ${item.frontDesigner || 'Non spécifié'}</div>
                                    <div>Implanteur: ${item.backImplanter || 'Non spécifié'}</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    content += `<div class="detail-item text-gray-500">Aucun article ce mois-ci</div>`;
                }
            });

            content += `
                    </div>
                </div>
            `;

            return content;
        }

        // Fonction pour générer le contenu des statistiques générales
        function generateGeneralStatsDetailContent(allItems) {
            const uniqueDesigners = new Set();
            const uniqueImplanters = new Set();
            const uniqueProjects = new Set();
            const typeStats = { Maquette: 0, Produit: 0 };

            allItems.forEach(item => {
                if (item.frontDesigner && item.frontDesigner.trim()) {
                    uniqueDesigners.add(item.frontDesigner.trim());
                }
                if (item.backImplanter && item.backImplanter.trim()) {
                    uniqueImplanters.add(item.backImplanter.trim());
                }
                if (item.name && item.name.trim()) {
                    uniqueProjects.add(item.name.trim());
                }
                typeStats[item.type || 'Maquette']++;
            });

            let content = `
                <div class="chart-detail-left">
                    <div class="statistics-grid">
                        <div class="stat-item">
                            <span class="stat-number">${uniqueDesigners.size}</span>
                            <span class="stat-label">Concepteurs uniques</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${uniqueImplanters.size}</span>
                            <span class="stat-label">Implanteurs uniques</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${uniqueProjects.size}</span>
                            <span class="stat-label">Projets uniques</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${typeStats.Maquette}</span>
                            <span class="stat-label">Maquettes</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${typeStats.Produit}</span>
                            <span class="stat-label">Produits</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${allItems.length}</span>
                            <span class="stat-label">Total articles</span>
                        </div>
                    </div>
                </div>
                <div class="chart-detail-right">
                    <h4 class="text-lg font-semibold mb-3">Listes détaillées</h4>
                    <div class="detail-list">
                        <h5 class="font-semibold mb-2 text-blue-600">Tous les concepteurs (${uniqueDesigners.size})</h5>
                        ${Array.from(uniqueDesigners).sort().map(designer => 
                            `<div class="detail-item">
                                <span>${designer}</span>
                                <span class="text-sm text-gray-600">${allItems.filter(item => item.frontDesigner === designer).length} articles</span>
                            </div>`
                        ).join('')}
                        
                        <h5 class="font-semibold mb-2 mt-4 text-green-600">Tous les implanteurs (${uniqueImplanters.size})</h5>
                        ${Array.from(uniqueImplanters).sort().map(implanter => 
                            `<div class="detail-item">
                                <span>${implanter}</span>
                                <span class="text-sm text-gray-600">${allItems.filter(item => item.backImplanter === implanter).length} articles</span>
                            </div>`
                        ).join('')}
                        
                        <h5 class="font-semibold mb-2 mt-4 text-purple-600">Tous les projets (${uniqueProjects.size})</h5>
                        ${Array.from(uniqueProjects).sort().map(project => 
                            `<div class="detail-item">
                                <span>${project}</span>
                                <span class="text-sm text-gray-600">${allItems.filter(item => item.name === project).length} occurrences</span>
                            </div>`
                        ).join('')}
                    </div>
                </div>
            `;

            return content;
        }
		        // Fonction pour générer le contenu détaillé du total d'articles
        function generateTotalArticlesDetailContent(allItems) {
            const currentData = getCurrentYearData();
            
            let content = `
                <div class="chart-detail-left">
                    <div class="statistics-grid">
                        <div class="stat-item">
                            <span class="stat-number">${currentData.nouveautes.length}</span>
                            <span class="stat-label">Nouveautés</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${currentData.evolutions.length}</span>
                            <span class="stat-label">Évolutions</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${currentData.diversifications.length}</span>
                            <span class="stat-label">Diversifications</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${allItems.length}</span>
                            <span class="stat-label">Total cumulé</span>
                        </div>
                    </div>
                </div>
                <div class="chart-detail-right">
                    <h4 class="text-lg font-semibold mb-3">Liste détaillée cumulative</h4>
                    <div class="detail-list">
            `;

            // Trier les articles par date de création (plus récents en premier)
            const sortedItems = [...allItems].sort((a, b) => {
                const dateA = a.dateCreation ? parseDate(a.dateCreation) : new Date(0);
                const dateB = b.dateCreation ? parseDate(b.dateCreation) : new Date(0);
                return dateB - dateA;
            });

            sortedItems.forEach(item => {
                const category = getCurrentItemCategory(item);
                const categoryColors = {
                    'nouveautes': 'text-blue-600',
                    'evolutions': 'text-red-600',
                    'diversifications': 'text-green-600'
                };
                const categoryLabels = {
                    'nouveautes': 'Nouveauté',
                    'evolutions': 'Évolution',
                    'diversifications': 'Diversification'
                };

                content += `
                    <div class="detail-item">
                        <div>
                            <strong>${item.name || 'Sans nom'}</strong>
                            <span class="text-sm ${categoryColors[category] || 'text-gray-600'}">(${categoryLabels[category] || 'Inconnu'})</span>
                            <div class="text-sm text-gray-600">
                                N° ${item.number || 'Non spécifié'} • ${item.type || 'Maquette'} • ${item.dateCreation || 'Date inconnue'}
                            </div>
                            <div class="text-xs text-gray-500">
                                Concepteur: ${item.frontDesigner || 'Non spécifié'} • Implanteur: ${item.backImplanter || 'Non spécifié'}
                            </div>
                        </div>
                    </div>
                `;
            });

            content += `
                    </div>
                </div>
            `;

            return content;
        }

        // Fonction pour générer le contenu détaillé des top implanteurs
        function generateTopImplantersDetailContent(allItems) {
            const implantersData = {};
            
            allItems.forEach(item => {
                if (item.backImplanter && item.backImplanter.trim()) {
                    if (!implantersData[item.backImplanter]) {
                        implantersData[item.backImplanter] = {
                            count: 0,
                            projects: [],
                            types: { Maquette: 0, Produit: 0 }
                        };
                    }
                    implantersData[item.backImplanter].count++;
                    implantersData[item.backImplanter].projects.push(item);
                    implantersData[item.backImplanter].types[item.type || 'Maquette']++;
                }
            });

            const sortedImplanters = Object.entries(implantersData)
                .sort((a, b) => b[1].count - a[1].count);

            let content = `
                <div class="chart-detail-left">
                    <div class="detail-chart-container">
                        <canvas id="detail-implanters-chart"></canvas>
                    </div>
                    <div class="statistics-grid">
                        <div class="stat-item">
                            <span class="stat-number">${sortedImplanters.length}</span>
                            <span class="stat-label">Implanteurs totaux</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${sortedImplanters.length > 0 ? Math.round(allItems.length / sortedImplanters.length) : 0}</span>
                            <span class="stat-label">Moyenne par implanteur</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${sortedImplanters.length > 0 ? sortedImplanters[0][1].count : 0}</span>
                            <span class="stat-label">Maximum par implanteur</span>
                        </div>
                    </div>
                </div>
                <div class="chart-detail-right">
                    <h4 class="text-lg font-semibold mb-3">Tous les implanteurs et leurs projets</h4>
                    <div class="detail-list">
            `;

            sortedImplanters.forEach(([implanter, data], index) => {
                content += `
                    <div class="detail-item">
                        <div>
                            <strong>${implanter}</strong>
                            <span class="text-sm text-gray-600">(${data.count} articles)</span>
                            <div class="text-xs text-gray-500">
                                Maquettes: ${data.types.Maquette} • Produits: ${data.types.Produit}
                            </div>
                        </div>
                        <div class="text-sm font-semibold">#${index + 1}</div>
                    </div>
                `;

                // Afficher les projets de cet implanteur
                data.projects.slice(0, 3).forEach(project => {
                    content += `
                        <div class="detail-item ml-4" style="border-left: 2px solid #e5e7eb; padding-left: 1rem;">
                            <div class="text-sm">
                                ${project.name || 'Sans nom'} 
                                <span class="text-xs text-gray-500">(${project.type || 'Maquette'}, ${project.dateCreation || 'Date inconnue'})</span>
                            </div>
                        </div>
                    `;
                });

                if (data.projects.length > 3) {
                    content += `
                        <div class="detail-item ml-4 text-xs text-gray-500" style="border-left: 2px solid #e5e7eb; padding-left: 1rem;">
                            ... et ${data.projects.length - 3} autres projets
                        </div>
                    `;
                }
            });

            content += `
                    </div>
                </div>
            `;

            return content;
        }

        // Fonction pour générer le contenu détaillé des top concepteurs
        function generateTopDesignersDetailContent(allItems) {
            const designersData = {};
            
            allItems.forEach(item => {
                if (item.frontDesigner && item.frontDesigner.trim()) {
                    if (!designersData[item.frontDesigner]) {
                        designersData[item.frontDesigner] = {
                            count: 0,
                            projects: [],
                            types: { Maquette: 0, Produit: 0 }
                        };
                    }
                    designersData[item.frontDesigner].count++;
                    designersData[item.frontDesigner].projects.push(item);
                    designersData[item.frontDesigner].types[item.type || 'Maquette']++;
                }
            });

            const sortedDesigners = Object.entries(designersData)
                .sort((a, b) => b[1].count - a[1].count);

            let content = `
                <div class="chart-detail-left">
                    <div class="detail-chart-container">
                        <canvas id="detail-designers-chart"></canvas>
                    </div>
                    <div class="statistics-grid">
                        <div class="stat-item">
                            <span class="stat-number">${sortedDesigners.length}</span>
                            <span class="stat-label">Concepteurs totaux</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${sortedDesigners.length > 0 ? Math.round(allItems.length / sortedDesigners.length) : 0}</span>
                            <span class="stat-label">Moyenne par concepteur</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${sortedDesigners.length > 0 ? sortedDesigners[0][1].count : 0}</span>
                            <span class="stat-label">Maximum par concepteur</span>
                        </div>
                    </div>
                </div>
                <div class="chart-detail-right">
                    <h4 class="text-lg font-semibold mb-3">Tous les concepteurs et leurs projets</h4>
                    <div class="detail-list">
            `;

            sortedDesigners.forEach(([designer, data], index) => {
                content += `
                    <div class="detail-item">
                        <div>
                            <strong>${designer}</strong>
                            <span class="text-sm text-gray-600">(${data.count} articles)</span>
                            <div class="text-xs text-gray-500">
                                Maquettes: ${data.types.Maquette} • Produits: ${data.types.Produit}
                            </div>
                        </div>
                        <div class="text-sm font-semibold">#${index + 1}</div>
                    </div>
                `;

                // Afficher les projets de ce concepteur
                data.projects.slice(0, 3).forEach(project => {
                    content += `
                        <div class="detail-item ml-4" style="border-left: 2px solid #e5e7eb; padding-left: 1rem;">
                            <div class="text-sm">
                                ${project.name || 'Sans nom'} 
                                <span class="text-xs text-gray-500">(${project.type || 'Maquette'}, ${project.dateCreation || 'Date inconnue'})</span>
                            </div>
                        </div>
                    `;
                });

                if (data.projects.length > 3) {
                    content += `
                        <div class="detail-item ml-4 text-xs text-gray-500" style="border-left: 2px solid #e5e7eb; padding-left: 1rem;">
                            ... et ${data.projects.length - 3} autres projets
                        </div>
                    `;
                }
            });

            content += `
                    </div>
                </div>
            `;

            return content;
        }

        // Fonction utilitaire pour générer une liste d'éléments d'une catégorie
        function generateCategoryItemsList(items) {
            if (items.length === 0) {
                return '<div class="detail-item text-gray-500">Aucun élément dans cette catégorie</div>';
            }

            return items.map(item => `
                <div class="detail-item">
                    <div>
                        <strong>${item.name || 'Sans nom'}</strong>
                        <div class="text-sm text-gray-600">
                            N° ${item.number || 'Non spécifié'} • ${item.type || 'Maquette'} • ${item.dateCreation || 'Date inconnue'}
                        </div>
                        <div class="text-xs text-gray-500">
                            Concepteur: ${item.frontDesigner || 'Non spécifié'} • Implanteur: ${item.backImplanter || 'Non spécifié'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Fonction pour générer un tableau de comparaison par année
        function generateYearlyComparisonTable() {
            const yearStats = {};
            
            state.availableYears.forEach(year => {
                if (state.data[year]) {
                    yearStats[year] = {
                        nouveautes: state.data[year].nouveautes.length,
                        evolutions: state.data[year].evolutions.length,
                        diversifications: state.data[year].diversifications.length,
                        total: state.data[year].nouveautes.length + state.data[year].evolutions.length + state.data[year].diversifications.length
                    };
                }
            });

            let content = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Année</th>
                            <th>Nouveautés</th>
                            <th>Évolutions</th>
                            <th>Diversifications</th>
                            <th>Total</th>
                            <th>Tendance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const sortedYears = Object.keys(yearStats).sort();
            
            sortedYears.forEach((year, index) => {
                const stats = yearStats[year];
                let trend = '';
                
                if (index > 0) {
                    const prevYear = sortedYears[index - 1];
                    const prevTotal = yearStats[prevYear].total;
                    const currentTotal = stats.total;
                    
                    if (currentTotal > prevTotal) {
                        const increase = currentTotal - prevTotal;
                        trend = `<span class="trend-indicator trend-up"><i class="fas fa-arrow-up"></i> +${increase}</span>`;
                    } else if (currentTotal < prevTotal) {
                        const decrease = prevTotal - currentTotal;
                        trend = `<span class="trend-indicator trend-down"><i class="fas fa-arrow-down"></i> -${decrease}</span>`;
                    } else {
                        trend = `<span class="trend-indicator trend-stable"><i class="fas fa-minus"></i> =</span>`;
                    }
                }

                content += `
                    <tr>
                        <td><strong>${year}</strong></td>
                        <td>${stats.nouveautes}</td>
                        <td>${stats.evolutions}</td>
                        <td>${stats.diversifications}</td>
                        <td><strong>${stats.total}</strong></td>
                        <td>${trend}</td>
                    </tr>
                `;
            });

            content += `
                    </tbody>
                </table>
            `;

            return content;
        }

        // Fonction pour déterminer la catégorie d'un élément
        function getCurrentItemCategory(item) {
            const currentData = getCurrentYearData();
            
            if (currentData.nouveautes.some(n => n.id === item.id)) return 'nouveautes';
            if (currentData.evolutions.some(e => e.id === item.id)) return 'evolutions';
            if (currentData.diversifications.some(d => d.id === item.id)) return 'diversifications';
            
            return 'unknown';
        }

        // Fonction pour initialiser les graphiques détaillés (CORRIGÉE)
		function initDetailCharts(chartType) {
			try {
				if (chartType === 'distribution') {
					initDetailDistributionChart();
				} else if (chartType === 'monthly') {
					initDetailMonthlyChart();
				} else if (chartType === 'top-implanters') {
					initDetailImplantersChart();
				} else if (chartType === 'top-designers') {
					initDetailDesignersChart();
				}
			} catch (error) {
				console.error('Erreur lors de l\'initialisation du graphique détaillé:', error);
				// Réessayer après un autre délai
				setTimeout(() => {
					initDetailCharts(chartType);
				}, 300);
			}
		}

        // Fonction pour initialiser le graphique de distribution détaillé
        function initDetailDistributionChart() {
            const canvas = document.getElementById('detail-distribution-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const currentData = getCurrentYearData();

            const data = {
                labels: ['Nouveautés', 'Évolutions', 'Diversifications'],
                datasets: [{
                    data: [
                        currentData.nouveautes.length,
                        currentData.evolutions.length,
                        currentData.diversifications.length
                    ],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(75, 192, 192, 0.8)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 2
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} articles (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: 'white',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        formatter: (value, context) => {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return value > 0 ? `${value}\n${percentage}%` : '';
                        },
                        anchor: 'center',
                        align: 'center'
                    }
                }
            };

            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: options,
                plugins: [ChartDataLabels]
            });
        }

        // Fonction pour initialiser le graphique mensuel détaillé
        function initDetailMonthlyChart() {
            const canvas = document.getElementById('detail-monthly-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const currentData = getCurrentYearData();
            const allItems = [...currentData.nouveautes, ...currentData.evolutions, ...currentData.diversifications];

            const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
            const monthlyData = {
                nouveautes: Array(12).fill(0),
                evolutions: Array(12).fill(0),
                diversifications: Array(12).fill(0)
            };

            // Compter les articles par mois et par catégorie
            ['nouveautes', 'evolutions', 'diversifications'].forEach(category => {
                currentData[category].forEach(item => {
                    if (item.dateCreation) {
                        const date = parseDate(item.dateCreation);
                        if (date) {
                            const month = date.getMonth();
                            monthlyData[category][month]++;
                        }
                    }
                });
            });

            const data = {
                labels: months,
                datasets: [
                    {
                        label: 'Nouveautés',
                        data: monthlyData.nouveautes,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Évolutions',
                        data: monthlyData.evolutions,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Diversifications',
                        data: monthlyData.diversifications,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }
                ]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            };

            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: options
            });
        }

        // Fonction pour initialiser le graphique des implanteurs détaillé (CORRIGÉE)
		function initDetailImplantersChart() {
			const canvas = document.getElementById('detail-implanters-chart');
			if (!canvas) {
				console.warn('Canvas detail-implanters-chart non trouvé');
				return;
			}

			const ctx = canvas.getContext('2d');
			const currentData = getCurrentYearData();
			const allItems = [...currentData.nouveautes, ...currentData.evolutions, ...currentData.diversifications];

			const implantersData = {};
			allItems.forEach(item => {
				if (item.backImplanter && item.backImplanter.trim()) {
					if (!implantersData[item.backImplanter]) {
						implantersData[item.backImplanter] = 0;
					}
					implantersData[item.backImplanter]++;
				}
			});

			const sortedImplanters = Object.entries(implantersData)
				.sort((a, b) => b[1] - a[1]);

			// Prendre tous les implanteurs, pas seulement le top 10
			const labels = sortedImplanters.map(item => item[0]);
			const values = sortedImplanters.map(item => item[1]);

			// Générer des couleurs dynamiquement
			const colors = labels.map((_, index) => {
				const hue = (index * 137.508) % 360; // Nombre d'or pour une bonne répartition
				return {
					background: `hsla(${hue}, 70%, 60%, 0.8)`,
					border: `hsla(${hue}, 70%, 50%, 1)`
				};
			});

			const data = {
				labels: labels,
				datasets: [{
					label: 'Nombre d\'articles',
					data: values,
					backgroundColor: colors.map(c => c.background),
					borderColor: colors.map(c => c.border),
					borderWidth: 2
				}]
			};

			const options = {
				responsive: true,
				maintainAspectRatio: false,
				indexAxis: 'y',
				scales: {
					x: {
						beginAtZero: true,
						ticks: {
							stepSize: 1
						}
					},
					y: {
						ticks: {
							maxRotation: 0,
							font: {
								size: 10
							}
						}
					}
				},
				plugins: {
					legend: {
						display: false
					},
					datalabels: {
						display: true,
						color: 'white',
						font: {
							size: 12,
							weight: 'bold'
						},
						formatter: (value) => value,
						anchor: 'center',
						align: 'center'
					},
					tooltip: {
						callbacks: {
							title: function(context) {
								return context[0].label;
							},
							label: function(context) {
								return `${context.raw} article${context.raw > 1 ? 's' : ''}`;
							}
						}
					}
				}
			};

			try {
				new Chart(ctx, {
					type: 'bar',
					data: data,
					options: options,
					plugins: [ChartDataLabels]
				});
			} catch (error) {
				console.error('Erreur lors de la création du graphique des implanteurs:', error);
			}
		}

        // Fonction pour initialiser le graphique des concepteurs détaillé (CORRIGÉE)
		function initDetailDesignersChart() {
			const canvas = document.getElementById('detail-designers-chart');
			if (!canvas) {
				console.warn('Canvas detail-designers-chart non trouvé');
				return;
			}

			const ctx = canvas.getContext('2d');
			const currentData = getCurrentYearData();
			const allItems = [...currentData.nouveautes, ...currentData.evolutions, ...currentData.diversifications];

			const designersData = {};
			allItems.forEach(item => {
				if (item.frontDesigner && item.frontDesigner.trim()) {
					if (!designersData[item.frontDesigner]) {
						designersData[item.frontDesigner] = 0;
					}
					designersData[item.frontDesigner]++;
				}
			});

			const sortedDesigners = Object.entries(designersData)
				.sort((a, b) => b[1] - a[1]);

			// Prendre tous les concepteurs, pas seulement le top 10
			const labels = sortedDesigners.map(item => item[0]);
			const values = sortedDesigners.map(item => item[1]);

			// Générer des couleurs dynamiquement
			const colors = labels.map((_, index) => {
				const hue = (index * 137.508 + 180) % 360; // Décalage de 180° par rapport aux implanteurs
				return {
					background: `hsla(${hue}, 70%, 60%, 0.8)`,
					border: `hsla(${hue}, 70%, 50%, 1)`
				};
			});

			const data = {
				labels: labels,
				datasets: [{
					label: 'Nombre d\'articles',
					data: values,
					backgroundColor: colors.map(c => c.background),
					borderColor: colors.map(c => c.border),
					borderWidth: 2
				}]
			};

			const options = {
				responsive: true,
				maintainAspectRatio: false,
				indexAxis: 'y',
				scales: {
					x: {
						beginAtZero: true,
						ticks: {
							stepSize: 1
						}
					},
					y: {
						ticks: {
							maxRotation: 0,
							font: {
								size: 10
							}
						}
					}
				},
				plugins: {
					legend: {
						display: false
					},
					datalabels: {
						display: true,
						color: 'white',
						font: {
							size: 12,
							weight: 'bold'
						},
						formatter: (value) => value,
						anchor: 'center',
						align: 'center'
					},
					tooltip: {
						callbacks: {
							title: function(context) {
								return context[0].label;
							},
							label: function(context) {
								return `${context.raw} article${context.raw > 1 ? 's' : ''}`;
							}
						}
					}
				}
			};

			try {
				new Chart(ctx, {
					type: 'bar',
					data: data,
					options: options,
					plugins: [ChartDataLabels]
				});
			} catch (error) {
				console.error('Erreur lors de la création du graphique des concepteurs:', error);
			}
		}

        // Fonction pour initialiser la gestion des années
        function initYearManagement() {
            const yearSelect = document.getElementById('year-select');
            const createYearBtn = document.getElementById('create-year-btn');
            const deleteYearBtn = document.getElementById('delete-year-btn');

            // Mettre à jour le sélecteur d'années
            updateYearSelector();

            // Gérer le changement d'année - MODIFICATION: mettre à jour tous les onglets
            yearSelect.addEventListener('change', (e) => {
                state.currentYear = e.target.value;
                updateMainTitle();
                updateDashboard();
                updateAllTables(); // Ceci mettra à jour les tableaux de tous les onglets
            });

            // Créer une nouvelle année
            createYearBtn.addEventListener('click', () => {
                document.getElementById('create-year-popup').classList.add('active');
                document.getElementById('new-year-input').value = '';
            });

            // Supprimer une année
            deleteYearBtn.addEventListener('click', () => {
                if (state.currentYear === 'all') {
                    showToast('Impossible de supprimer "Toutes les années"');
                    return;
                }
                if (state.availableYears.length <= 1) {
                    showToast('Impossible de supprimer la dernière année');
                    return;
                }
                state.deleteYear = state.currentYear;
                document.getElementById('confirmation-popup').classList.add('active');
                document.querySelector('#confirmation-popup p').textContent = 
                    `Êtes-vous sûr de vouloir supprimer l'année ${state.currentYear} et toutes ses données ? Cette action est irréversible.`;
            });

                        // Popup de création d'année
            document.getElementById('close-create-year').addEventListener('click', () => {
                document.getElementById('create-year-popup').classList.remove('active');
            });
            
            document.getElementById('cancel-create-year').addEventListener('click', () => {
                document.getElementById('create-year-popup').classList.remove('active');
            });
            
            document.getElementById('confirm-create-year').addEventListener('click', () => {
                const newYear = document.getElementById('new-year-input').value;
                if (!newYear || newYear.length !== 4) {
                    showToast('Veuillez entrer une année valide (4 chiffres)');
                    return;
                }
                if (state.availableYears.includes(newYear)) {
                    showToast('Cette année existe déjà');
                    return;
                }
                
                // Créer la nouvelle année
                state.availableYears.push(newYear);
                state.availableYears.sort();
                state.data[newYear] = {
                    nouveautes: [],
                    evolutions: [],
                    diversifications: []
                };
                
                // Mettre à jour l'interface
                updateYearSelector();
                state.currentYear = newYear;
                document.getElementById('year-select').value = newYear;
                updateMainTitle();
                
                // Sauvegarder et fermer
                saveData();
                document.getElementById('create-year-popup').classList.remove('active');
                showToast(`Année ${newYear} créée avec succès`);
                
                updateDashboard();
                updateAllTables();
            });
        }

        // Fonction pour mettre à jour le sélecteur d'années
        function updateYearSelector() {
            const yearSelect = document.getElementById('year-select');
            const currentValue = yearSelect.value;
            
            yearSelect.innerHTML = '';
            
            // Ajouter les années disponibles
            state.availableYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            // Ajouter l'option "Toutes les années"
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Toutes les années';
            yearSelect.appendChild(allOption);
            
            // Restaurer la valeur sélectionnée si elle existe encore
            if (state.availableYears.includes(currentValue) || currentValue === 'all') {
                yearSelect.value = currentValue;
            } else {
                yearSelect.value = state.availableYears[state.availableYears.length - 1] || '2025';
                state.currentYear = yearSelect.value;
            }
        }

        // Fonction pour mettre à jour le titre principal
        function updateMainTitle() {
            const title = document.getElementById('main-title');
            if (state.currentYear === 'all') {
                title.textContent = 'Bilan - Toutes les années';
            } else {
                title.textContent = `Bilan ${state.currentYear}`;
            }
        }

        // Fonction pour obtenir les données de l'année courante
        function getCurrentYearData() {
            if (state.currentYear === 'all') {
                // Combiner toutes les années
                const combined = {
                    nouveautes: [],
                    evolutions: [],
                    diversifications: []
                };
                
                state.availableYears.forEach(year => {
                    if (state.data[year]) {
                        combined.nouveautes.push(...state.data[year].nouveautes);
                        combined.evolutions.push(...state.data[year].evolutions);
                        combined.diversifications.push(...state.data[year].diversifications);
                    }
                });
                
                return combined;
            } else {
                return state.data[state.currentYear] || {
                    nouveautes: [],
                    evolutions: [],
                    diversifications: []
                };
            }
        }

        // Fonction pour charger les données depuis localStorage
        function loadData() {
            try {
                // Charger les années disponibles
                const availableYears = localStorage.getItem('availableYears');
                if (availableYears) {
                    state.availableYears = JSON.parse(availableYears);
                }
                
                // Charger l'année courante
                const currentYear = localStorage.getItem('currentYear');
                if (currentYear && (state.availableYears.includes(currentYear) || currentYear === 'all')) {
                    state.currentYear = currentYear;
                }
                
                // Charger les données pour chaque année
                state.availableYears.forEach(year => {
                    const yearData = localStorage.getItem(`data_${year}`);
                    if (yearData) {
                        state.data[year] = JSON.parse(yearData);
                    } else {
                        state.data[year] = {
                            nouveautes: [],
                            evolutions: [],
                            diversifications: []
                        };
                    }
                });
                
                // Charger les dernières valeurs de formulaire
                const lastFormValues = localStorage.getItem('lastFormValues');
                if (lastFormValues) {
                    state.lastFormValues = JSON.parse(lastFormValues);
                }
                
                // Migration des anciennes données (compatibilité)
                const oldNouveautes = localStorage.getItem('nouveautes');
                const oldEvolutions = localStorage.getItem('evolutions');
                const oldDiversifications = localStorage.getItem('diversifications');
                
                if (oldNouveautes || oldEvolutions || oldDiversifications) {
                    if (!state.data['2025']) {
                        state.data['2025'] = {
                            nouveautes: [],
                            evolutions: [],
                            diversifications: []
                        };
                    }
                    
                    if (oldNouveautes) {
                        state.data['2025'].nouveautes = JSON.parse(oldNouveautes);
                        localStorage.removeItem('nouveautes');
                    }
                    if (oldEvolutions) {
                        state.data['2025'].evolutions = JSON.parse(oldEvolutions);
                        localStorage.removeItem('evolutions');
                    }
                    if (oldDiversifications) {
                        state.data['2025'].diversifications = JSON.parse(oldDiversifications);
                        localStorage.removeItem('diversifications');
                    }
                    
                    saveData(); // Sauvegarder la migration
                }
                
                const darkMode = localStorage.getItem('darkMode');
                if (darkMode === 'true') {
                    state.darkMode = true;
                    document.body.classList.add('dark-mode');
                    document.getElementById('dark-mode-toggle').checked = true;
                }
                
                updateMainTitle();
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                showToast('Erreur lors du chargement des données');
            }
        }

        // Fonction pour sauvegarder les données dans localStorage
        function saveData() {
            try {
                // Sauvegarder les années disponibles
                localStorage.setItem('availableYears', JSON.stringify(state.availableYears));
                
                // Sauvegarder l'année courante
                localStorage.setItem('currentYear', state.currentYear);
                
                // Sauvegarder les données de chaque année
                state.availableYears.forEach(year => {
                    if (state.data[year]) {
                        localStorage.setItem(`data_${year}`, JSON.stringify(state.data[year]));
                    }
                });
                
                // Sauvegarder les dernières valeurs de formulaire
                localStorage.setItem('lastFormValues', JSON.stringify(state.lastFormValues));
                
                const timestamp = Date.now();
                localStorage.setItem('lastSaveTime', timestamp);

                // Ne mettre à jour l'affichage que s'il n'y a pas eu d'export JSON récent
                const lastJsonExport = localStorage.getItem('lastJsonExportTime');
                if (!lastJsonExport || parseInt(lastJsonExport) < timestamp) {
                    document.getElementById('last-save-time').textContent = new Date(timestamp).toLocaleString();
                }

                showToast('Données sauvegardées avec succès');
                updateDashboard();
            } catch (error) {
                console.error('Erreur lors de la sauvegarde des données:', error);
                showToast('Erreur lors de la sauvegarde des données');
            }
        }

        // Fonction pour sauvegarder les valeurs du formulaire
        function saveFormValues() {
            const formFields = [
                'form-name', 'form-number', 'form-type', 
                'form-front-designer', 'form-back-implanter', 'form-comments'
            ];
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim()) {
                    state.lastFormValues[fieldId] = field.value;
                }
            });
            
            localStorage.setItem('lastFormValues', JSON.stringify(state.lastFormValues));
        }

        // Fonction pour restaurer les valeurs du formulaire
        function restoreFormValues() {
            const formFields = [
                'form-name', 'form-number', 'form-type', 
                'form-front-designer', 'form-back-implanter', 'form-comments'
            ];
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && state.lastFormValues[fieldId] && !field.value) {
                    field.value = state.lastFormValues[fieldId];
                }
            });
        }

        // Fonction pour mettre à jour tous les tableaux
        function updateAllTables() {
            updateTable('nouveautes');
            updateTable('evolutions');
            updateTable('diversifications');
        }

        // Fonction pour initialiser les onglets
        function initTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Désactiver tous les onglets
                    tabs.forEach(t => t.classList.remove('active'));
                    tabPanes.forEach(p => p.classList.add('hidden'));
                    
                    // Activer l'onglet cliqué
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.remove('hidden');
                    
                    // Mettre à jour les tableaux si nécessaire
                    if (tabId === 'nouveautes') {
                        updateTable('nouveautes');
                    } else if (tabId === 'evolutions') {
                        updateTable('evolutions');
                    } else if (tabId === 'diversifications') {
                        updateTable('diversifications');
                    } else if (tabId === 'dashboard') {
                        updateDashboard();
                    }
                });
            });
            
            // Initialiser les tableaux
            updateAllTables();
        }

        // Fonction pour initialiser les popups
        function initPopups() {
            // Popup d'ajout d'élément
            document.getElementById('add-nouveaute').addEventListener('click', () => {
                openAddPopup('nouveautes');
            });
            
            document.getElementById('add-evolution').addEventListener('click', () => {
                openAddPopup('evolutions');
            });
            
            document.getElementById('add-diversification').addEventListener('click', () => {
                openAddPopup('diversifications');
            });
            
            // Fermeture des popups
            document.getElementById('close-popup').addEventListener('click', () => {
                document.getElementById('item-popup').classList.remove('active');
            });
            
            document.getElementById('cancel-form').addEventListener('click', () => {
                document.getElementById('item-popup').classList.remove('active');
            });
            
            // Popup de réglages
            document.getElementById('settings-button').addEventListener('click', () => {
                document.getElementById('settings-popup').classList.add('active');
            });
            
            document.getElementById('close-settings').addEventListener('click', () => {
                document.getElementById('settings-popup').classList.remove('active');
            });
            
            // Popup de confirmation de suppression
            document.getElementById('cancel-delete').addEventListener('click', () => {
                document.getElementById('confirmation-popup').classList.remove('active');
                state.deleteYear = null;
            });
            
            document.getElementById('confirm-delete').addEventListener('click', () => {
                if (state.deleteYear) {
                    // Supprimer une année
                    deleteYear(state.deleteYear);
                    state.deleteYear = null;
                } else if (state.deleteItemId !== null && state.currentCategory) {
                    // Supprimer un élément
                    deleteItem(state.currentCategory, state.deleteItemId);
                }
                document.getElementById('confirmation-popup').classList.remove('active');
                // Restaurer le texte par défaut
                document.querySelector('#confirmation-popup p').textContent = 
                    'Êtes-vous sûr de vouloir supprimer cet élément ? Cette action est irréversible.';
            });

            // Popup d'import d'année
            document.getElementById('close-import-year').addEventListener('click', () => {
                document.getElementById('import-year-popup').classList.remove('active');
                state.pendingImportData = null;
            });
            
            document.getElementById('cancel-import-year').addEventListener('click', () => {
                document.getElementById('import-year-popup').classList.remove('active');
                state.pendingImportData = null;
            });
            
            document.getElementById('confirm-import-year').addEventListener('click', () => {
                const selectedYear = document.getElementById('import-year-select').value;
                if (state.pendingImportData && selectedYear) {
                    performImport(state.pendingImportData, selectedYear);
                }
                document.getElementById('import-year-popup').classList.remove('active');
                state.pendingImportData = null;
            });
        }

        // Fonction pour supprimer une année
        function deleteYear(year) {
            if (!state.availableYears.includes(year) || state.availableYears.length <= 1) {
                showToast('Impossible de supprimer cette année');
                return;
            }
            
            // Supprimer l'année des données
            delete state.data[year];
            state.availableYears = state.availableYears.filter(y => y !== year);
            
            // Supprimer du localStorage
            localStorage.removeItem(`data_${year}`);
            
            // Changer l'année courante si nécessaire
            if (state.currentYear === year) {
                state.currentYear = state.availableYears[state.availableYears.length - 1];
                document.getElementById('year-select').value = state.currentYear;
                updateMainTitle();
            }
            
            // Mettre à jour l'interface
            updateYearSelector();
            saveData();
            updateDashboard();
            updateAllTables();
            
            showToast(`Année ${year} supprimée avec succès`);
        }

		// Fonction pour ouvrir le popup d'ajout
		function openAddPopup(category) {
			if (state.currentYear === 'all') {
				showToast('Veuillez sélectionner une année spécifique pour ajouter un élément');
				return;
			}
			
			// Réinitialiser le formulaire
			document.getElementById('item-form').reset();
			document.getElementById('form-id').value = '';
			document.getElementById('form-category').value = category;
			
			// Définir le titre du popup
			let title = '';
			if (category === 'nouveautes') {
				title = 'Ajouter un nouvel article - Nouveautés';
			} else if (category === 'evolutions') {
				title = 'Ajouter un nouvel article - Évolutions';
			} else if (category === 'diversifications') {
				title = 'Ajouter un nouvel article - Diversifications';
			}
			document.getElementById('popup-title').textContent = title;
			
			// Ouvrir le popup
			document.getElementById('item-popup').classList.add('active');
			
			// Initialiser la date de création avec la date du jour
			const today = new Date();
			const formattedDate = formatDate(today);
			document.getElementById('form-date-creation').value = formattedDate;
			
			// CORRECTION : Ne pas restaurer les dernières valeurs pour un nouvel ajout
			// restoreFormValues(); // <- Cette ligne est supprimée
			
			state.currentCategory = category;
		}



        // Fonction pour ouvrir le popup d'édition
        function openEditPopup(category, id) {
            if (state.currentYear === 'all') {
                showToast('Veuillez sélectionner une année spécifique pour modifier un élément');
                return;
            }
            
            // Trouver l'élément à éditer
            const yearData = state.data[state.currentYear];
            if (!yearData) return;
            
            const items = yearData[category];
            const item = items.find(item => item.id === id);
            
            if (!item) return;
            
            // Remplir le formulaire avec les données de l'élément
            document.getElementById('form-id').value = item.id;
            document.getElementById('form-category').value = category;
            document.getElementById('form-date-creation').value = item.dateCreation || '';
            document.getElementById('form-date-schema-review').value = item.dateSchemaReview || '';
            document.getElementById('form-date-implantation-review').value = item.dateImplantationReview || '';
            document.getElementById('form-date-plm').value = item.datePLM || '';
            document.getElementById('form-name').value = item.name || '';
            document.getElementById('form-number').value = item.number || '';
            document.getElementById('form-type').value = item.type || 'Maquette';
            document.getElementById('form-front-designer').value = item.frontDesigner || '';
            document.getElementById('form-back-implanter').value = item.backImplanter || '';
            document.getElementById('form-comments').value = item.comments || '';
            
            // Définir le titre du popup
            let title = '';
            if (category === 'nouveautes') {
                title = 'Modifier un article - Nouveautés';
            } else if (category === 'evolutions') {
                title = 'Modifier un article - Évolutions';
            } else if (category === 'diversifications') {
                title = 'Modifier un article - Diversifications';
            }
            document.getElementById('popup-title').textContent = title;
            
            // Ouvrir le popup
            document.getElementById('item-popup').classList.add('active');
            
            state.currentCategory = category;
        }

        // Fonction pour initialiser les formulaires
        function initForms() {
            document.getElementById('item-form').addEventListener('submit', (event) => {
                event.preventDefault();
                
                if (state.currentYear === 'all') {
                    showToast('Veuillez sélectionner une année spécifique');
                    return;
                }
                
                // Sauvegarder les valeurs du formulaire avant traitement
                saveFormValues();
                
                // Récupérer les données du formulaire
                const id = document.getElementById('form-id').value;
                const category = document.getElementById('form-category').value;
                const dateCreation = document.getElementById('form-date-creation').value;
                const dateSchemaReview = document.getElementById('form-date-schema-review').value;
                const dateImplantationReview = document.getElementById('form-date-implantation-review').value;
                const datePLM = document.getElementById('form-date-plm').value;
                const name = document.getElementById('form-name').value;
                const number = document.getElementById('form-number').value;
                const type = document.getElementById('form-type').value;
                const frontDesigner = document.getElementById('form-front-designer').value;
                const backImplanter = document.getElementById('form-back-implanter').value;
                const comments = document.getElementById('form-comments').value;
                
                // Vérifier qu'au moins un champ est rempli
                if (!dateCreation && !dateSchemaReview && !dateImplantationReview && !datePLM && 
                    !name && !number && !type && !frontDesigner && !backImplanter && !comments) {
                    showToast('Veuillez remplir au moins un champ');
                    return;
                }
                
                // Créer l'objet item
                const item = {
                    dateCreation,
                    dateSchemaReview,
                    dateImplantationReview,
                    datePLM,
                    name,
                    number,
                    type,
                    frontDesigner,
                    backImplanter,
                    comments,
                    year: state.currentYear
                };
                
                // Ajouter ou modifier l'élément
                if (id) {
                    // Modifier un élément existant
                    updateItem(category, id, item);
                } else {
                    // Ajouter un nouvel élément
                    addItem(category, item);
                }
                
                // Fermer le popup
                document.getElementById('item-popup').classList.remove('active');
            });
        }

        // Fonction pour ajouter un élément
        function addItem(category, item) {
            // S'assurer que l'année existe
            if (!state.data[state.currentYear]) {
                state.data[state.currentYear] = {
                    nouveautes: [],
                    evolutions: [],
                    diversifications: []
                };
            }
            
            // Générer un ID unique
            item.id = Date.now().toString() + Math.random().toString(36).substr(2, 5);
            item.createdAt = new Date().toISOString();
            
            // Ajouter l'élément à la catégorie correspondante
            state.data[state.currentYear][category].push(item);
            
            // Sauvegarder les données
            saveData();
            
            // Mettre à jour le tableau
            updateTable(category);
            
            showToast('Élément ajouté avec succès');
        }

        // Fonction pour mettre à jour un élément
        function updateItem(category, id, newItem) {
            // Trouver l'élément à mettre à jour
            const yearData = state.data[state.currentYear];
            if (!yearData) return;
            
            const items = yearData[category];
            const index = items.findIndex(item => item.id === id);
            
            if (index === -1) return;
            
            // Conserver l'ID et la date de création
            newItem.id = id;
            newItem.createdAt = items[index].createdAt;
            newItem.updatedAt = new Date().toISOString();
            
            // Mettre à jour l'élément
            state.data[state.currentYear][category][index] = newItem;
            
            // Sauvegarder les données
            saveData();
            
            // Mettre à jour le tableau
            updateTable(category);
            
            showToast('Élément mis à jour avec succès');
        }

        // Fonction pour supprimer un élément
        function deleteItem(category, id) {
            // Trouver l'élément à supprimer dans toutes les années si on est en mode "all"
            let found = false;
            
            if (state.currentYear === 'all') {
                // Chercher dans toutes les années
                state.availableYears.forEach(year => {
                    if (state.data[year] && state.data[year][category]) {
                        const index = state.data[year][category].findIndex(item => item.id === id);
                        if (index !== -1) {
                            state.data[year][category].splice(index, 1);
                            found = true;
                        }
                    }
                });
            } else {
                // Chercher seulement dans l'année courante
                const yearData = state.data[state.currentYear];
                if (yearData && yearData[category]) {
                    const index = yearData[category].findIndex(item => item.id === id);
                    if (index !== -1) {
                        yearData[category].splice(index, 1);
                        found = true;
                    }
                }
            }
            
            if (!found) return;
            
            // Sauvegarder les données
            saveData();
            
            // Mettre à jour le tableau
            updateTable(category);
            
            showToast('Élément supprimé avec succès');
        }

        // Fonction pour confirmer la suppression d'un élément
        function confirmDelete(category, id) {
            state.deleteItemId = id;
            state.currentCategory = category;
            document.getElementById('confirmation-popup').classList.add('active');
        }
		        // Fonction pour mettre à jour un tableau
        function updateTable(category) {
            const tableId = category + '-table';
            const tableBody = document.querySelector(`#${tableId} tbody`);
            
            // Obtenir les données de l'année courante
            const currentData = getCurrentYearData();
            const items = [...currentData[category]]; // Copie pour le tri
            
            // Trier les éléments si nécessaire
            if (state.sortColumn) {
                items.sort((a, b) => {
                    const aValue = a[state.sortColumn] || '';
                    const bValue = b[state.sortColumn] || '';
                    
                    // Si c'est une date, convertir en objet Date
                    if (state.sortColumn.startsWith('date') && aValue && bValue) {
                        const dateA = parseDate(aValue);
                        const dateB = parseDate(bValue);
                        
                        if (state.sortDirection === 'asc') {
                            return dateA - dateB;
                        } else {
                            return dateB - dateA;
                        }
                    }
                    
                    // Sinon, trier par chaîne de caractères
                    if (state.sortDirection === 'asc') {
                        return aValue.localeCompare(bValue);
                    } else {
                        return bValue.localeCompare(aValue);
                    }
                });
            }
            
            // Vider le tableau
            tableBody.innerHTML = '';
            
            // Aucun élément
            if (items.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.setAttribute('colspan', '11');
                cell.textContent = 'Aucun élément à afficher';
                cell.className = 'py-4 px-4 text-center text-gray-500';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }
            
            // Ajouter les éléments au tableau
            items.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-100 cursor-pointer';
                
                // Ajouter l'événement de clic pour éditer l'élément (seulement si pas en mode "all")
                if (state.currentYear !== 'all') {
                    row.addEventListener('click', (event) => {
                        // Ne pas déclencher si on clique sur le bouton de suppression
                        if (!event.target.closest('.delete-button')) {
                            openEditPopup(category, item.id);
                        }
                    });
                }
                
                // Créer les cellules
                [
                    'dateCreation', 'dateSchemaReview', 'dateImplantationReview', 'datePLM',
                    'name', 'number', 'type', 'frontDesigner', 'backImplanter', 'comments'
                ].forEach(field => {
                    const cell = document.createElement('td');
                    cell.className = 'py-3 px-4';
                    cell.textContent = item[field] || '';
                    row.appendChild(cell);
                });
                
                // Ajouter le bouton de suppression
                const actionsCell = document.createElement('td');
                actionsCell.className = 'py-3 px-4 text-center';
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-red-600 hover:text-red-800 delete-button';
                deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                deleteButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    confirmDelete(category, item.id);
                });
                
                actionsCell.appendChild(deleteButton);
                row.appendChild(actionsCell);
                
                tableBody.appendChild(row);
            });
        }

        // Fonction pour initialiser les calendriers
        function initCalendars() {
            const dateInputs = [
                'form-date-creation',
                'form-date-schema-review',
                'form-date-implantation-review',
                'form-date-plm'
            ];
            
            dateInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                const calendarId = inputId.replace('form-', 'calendar-');
                const calendar = document.getElementById(calendarId);
                
                input.addEventListener('click', () => {
                    // Fermer tous les autres calendriers
                    document.querySelectorAll('.calendar-popup').forEach(cal => {
                        if (cal.id !== calendarId) {
                            cal.style.display = 'none';
                        }
                    });
                    
                    // Afficher ou masquer le calendrier
                    calendar.style.display = calendar.style.display === 'block' ? 'none' : 'block';
                    
                    // Si le calendrier est affiché, générer le contenu
                    if (calendar.style.display === 'block') {
                        generateCalendar(input, calendar);
                    }
                });
                
                // Fermer le calendrier en cliquant ailleurs
                document.addEventListener('click', (event) => {
                    if (!input.contains(event.target) && !calendar.contains(event.target)) {
                        calendar.style.display = 'none';
                    }
                });
            });
        }

        // Fonction pour générer le contenu du calendrier
        function generateCalendar(input, calendar) {
            // Utiliser la date stockée ou la date de l'input, ou la date actuelle
            const calendarId = calendar.id;
            let currentDate;
            
            if (state.currentCalendarDate[calendarId]) {
                // Utiliser la date stockée pour ce calendrier
                currentDate = new Date(state.currentCalendarDate[calendarId]);
            } else if (input.value) {
                // Ou utiliser la date de l'input
                const selectedDate = parseDate(input.value);
                currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
            } else {
                // Ou utiliser la date actuelle
                const now = new Date();
                currentDate = new Date(now.getFullYear(), now.getMonth(), 1);
            }
            
            // Stocker la date courante pour ce calendrier
            state.currentCalendarDate[calendarId] = currentDate;
            
            // Créer l'en-tête du calendrier
            calendar.innerHTML = `
                <div class="calendar-header">
                    <button type="button" class="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <span class="month-year">${currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</span>
                    <button type="button" class="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-days">
                    <div class="calendar-day font-bold">Lu</div>
                    <div class="calendar-day font-bold">Ma</div>
                    <div class="calendar-day font-bold">Me</div>
                    <div class="calendar-day font-bold">Je</div>
                    <div class="calendar-day font-bold">Ve</div>
                    <div class="calendar-day font-bold">Sa</div>
                    <div class="calendar-day font-bold">Di</div>
                </div>
            `;
            
            // Ajouter les jours du mois
            const daysContainer = calendar.querySelector('.calendar-days');
            
            // Ajouter des jours vides pour commencer à partir du bon jour de la semaine
            let firstDay = currentDate.getDay();
            if (firstDay === 0) firstDay = 7; // En France, la semaine commence le lundi (1) et non le dimanche (0)
            firstDay--; // Convertir en base 0 pour l'index
            
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                daysContainer.appendChild(emptyDay);
            }
            
            // Ajouter les jours du mois
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            
            for (let i = 1; i <= lastDay; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.textContent = i;
                
                // Vérifier si ce jour est sélectionné
                if (input.value) {
                    const selectedDate = parseDate(input.value);
                    const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                    
                    if (selectedDate && 
                        dayDate.getDate() === selectedDate.getDate() && 
                        dayDate.getMonth() === selectedDate.getMonth() && 
                        dayDate.getFullYear() === selectedDate.getFullYear()) {
                        day.classList.add('selected');
                    }
                }
                
                // Ajouter l'événement de clic
                day.addEventListener('click', () => {
                    const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                    input.value = formatDate(selectedDate);
                    calendar.style.display = 'none';
                });
                
                daysContainer.appendChild(day);
            }
            
            // Ajouter les événements pour les boutons de mois précédent et suivant
            calendar.querySelector('.prev-month').addEventListener('click', (event) => {
                event.stopPropagation();
                // Soustraire un mois à la date courante
                currentDate.setMonth(currentDate.getMonth() - 1);
                // Mettre à jour la date stockée
                state.currentCalendarDate[calendarId] = new Date(currentDate);
                // Régénérer le calendrier
                generateCalendar(input, calendar);
            });
            
            calendar.querySelector('.next-month').addEventListener('click', (event) => {
                event.stopPropagation();
                // Ajouter un mois à la date courante
                currentDate.setMonth(currentDate.getMonth() + 1);
                // Mettre à jour la date stockée
                state.currentCalendarDate[calendarId] = new Date(currentDate);
                // Régénérer le calendrier
                generateCalendar(input, calendar);
            });
        }

        // Fonctions utilitaires pour les dates
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            
            const parts = dateString.split('/');
            if (parts.length !== 3) return new Date();
            
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            
            return new Date(year, month, day);
        }

        // Fonction pour initialiser les graphiques
        function initCharts() {
            // Charger les données pour les graphiques
            updateDashboard();
        }

        // Fonction pour mettre à jour le tableau de bord
        function updateDashboard() {
            const currentData = getCurrentYearData();
            
            // Mettre à jour le nombre total d'articles
            const totalArticles = currentData.nouveautes.length + currentData.evolutions.length + currentData.diversifications.length;
            document.getElementById('total-articles-simple').textContent = totalArticles;
            
            // Calculer le nombre de concepteurs et implanteurs uniques
            const allItems = [...currentData.nouveautes, ...currentData.evolutions, ...currentData.diversifications];
            const uniqueDesigners = new Set();
            const uniqueImplanters = new Set();
            
            allItems.forEach(item => {
                if (item.frontDesigner && item.frontDesigner.trim()) {
                    uniqueDesigners.add(item.frontDesigner.trim());
                }
                if (item.backImplanter && item.backImplanter.trim()) {
                    uniqueImplanters.add(item.backImplanter.trim());
                }
            });
            
            document.getElementById('total-designers').textContent = uniqueDesigners.size;
            document.getElementById('total-implanters').textContent = uniqueImplanters.size;
            
            // Créer ou mettre à jour les graphiques
            updateDistributionChart();
            updateMonthlyChart();
            updateTopImplantersChart();
            updateTopDesignersChart();
            
            // Si on est en mode "toutes les années", ajouter des graphiques supplémentaires
            if (state.currentYear === 'all') {
                updateYearlyTrendsChart();
                updateAnnualComparisonChart();
                updateCumulativeChart();
            }
        }

        // Fonction pour mettre à jour le graphique de répartition
        function updateDistributionChart() {
            const ctx = document.getElementById('distribution-chart').getContext('2d');
            
            // Détruire le graphique existant s'il existe
            if (state.charts.distribution) {
                state.charts.distribution.destroy();
            }
            
            const currentData = getCurrentYearData();
            
            // Données pour le camembert
            const data = {
                labels: ['Nouveautés', 'Évolutions', 'Diversifications'],
                datasets: [{
                    data: [
                        currentData.nouveautes.length, 
                        currentData.evolutions.length, 
                        currentData.diversifications.length
                    ],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(75, 192, 192, 0.7)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 1
                }]
            };
            
            // Options pour le camembert avec texte centré et agrandi
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
						display: true,
						color: 'white',
						font: {
							size: 16,
							weight: 'bold'
						},
						formatter: (value, context) => {
							const total = context.dataset.data.reduce((a, b) => a + b, 0);
							const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
							return percentage > 5 ? `${value}` : ''; // N'afficher que si > 5%
						},
						anchor: 'center',
						align: 'center'
					},
					// AJOUT DE CETTE CONFIGURATION IMPORTANTE :
					legend: {
						position: 'bottom',
						onClick: null // Désactive le clic sur la légende
					}
                }
            };
            
            // Créer le graphique
            state.charts.distribution = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: options,
                plugins: [ChartDataLabels]
            });
        }

        // Fonction pour mettre à jour le graphique mensuel (CORRIGÉE)
        function updateMonthlyChart() {
            const ctx = document.getElementById('monthly-chart').getContext('2d');
            
            // Détruire le graphique existant s'il existe
            if (state.charts.monthly) {
                state.charts.monthly.destroy();
            }
            
            const currentData = getCurrentYearData();
            
            // Préparer les données par mois et par type
            const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
            let datasets = [];
            
            if (state.currentYear === 'all') {
                // Mode "toutes les années" - distinguer par année ET par type
                const yearTypeData = {};
                
                // Initialiser les données pour chaque année et type
                state.availableYears.forEach(year => {
                    yearTypeData[`${year}_Maquette`] = Array(12).fill(0);
                    yearTypeData[`${year}_Produit`] = Array(12).fill(0);
                });
                
                // Compter les articles par mois, année et type - CORRECTION ICI
                const allItems = [...currentData.nouveautes, ...currentData.evolutions, ...currentData.diversifications];
                
                allItems.forEach(item => {
                    if (item.dateCreation) {
                        const date = parseDate(item.dateCreation);
                        if (date) {
                            const month = date.getMonth();
                            // CORRECTION: Utiliser l'année de l'item ou extraire de la date
                            let itemYear = item.year;
                            if (!itemYear) {
                                itemYear = date.getFullYear().toString();
                            }
                            const type = item.type || 'Maquette';
                            const key = `${itemYear}_${type}`;
                            
                            if (yearTypeData[key]) {
                                yearTypeData[key][month]++;
                            }
                        }
                    }
                });
                
                // Créer les datasets avec des couleurs distinctes pour chaque année et type
                const baseColors = {
                    'Maquette': { r: 54, g: 162, b: 235 },
                    'Produit': { r: 255, g: 99, b: 132 }
                };
                
                state.availableYears.forEach((year, yearIndex) => {
                    ['Maquette', 'Produit'].forEach(type => {
                        const key = `${year}_${type}`;
                        const baseColor = baseColors[type];
                        
                        // Calculer l'opacité basée sur l'index de l'année
                        const opacity = 0.4 + (yearIndex * 0.4 / state.availableYears.length);
                        
                        datasets.push({
                            label: `${year} - ${type}`,
                            data: yearTypeData[key],
                            backgroundColor: `rgba(${baseColor.r}, ${baseColor.g}, ${baseColor.b}, ${opacity})`,
                            borderColor: `rgba(${baseColor.r}, ${baseColor.g}, ${baseColor.b}, 1)`,
                            borderWidth: 1
                        });
                    });
                });
            } else {
                // Mode année unique - distinguer seulement par type
                const typeData = {
                    'Maquette': Array(12).fill(0),
                    'Produit': Array(12).fill(0)
                };
                
                // Compter les articles par mois et par type
                const allItems = [...currentData.nouveautes, ...currentData.evolutions, ...currentData.diversifications];
                
                allItems.forEach(item => {
                    if (item.dateCreation) {
                        const date = parseDate(item.dateCreation);
                        if (date) {
                            const month = date.getMonth();
                            const type = item.type || 'Maquette';
                            if (typeData[type]) {
                                typeData[type][month]++;
                            }
                        }
                    }
                });
                
                datasets = [
                    {
                        label: 'Maquette',
                        data: typeData['Maquette'],
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Produit',
                        data: typeData['Produit'],
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ];
            }
            
            // Données pour le graphique en barres empilées
            const data = {
                labels: months,
                datasets: datasets
            };
            
            // Options pour le graphique en barres empilées
			const options = {
				responsive: true,
				maintainAspectRatio: false,
				scales: {
					x: {
						stacked: true
					},
					y: {
						stacked: true,
						beginAtZero: true
					}
				},
				plugins: {
					legend: {
						position: 'bottom',
						labels: {
							usePointStyle: true,
							padding: 15
						},
						onClick: null, // Désactive le clic sur la légende
						onHover: null  // Désactive le survol de la légende
					},
					tooltip: {
						mode: 'index',
						intersect: false
					}
				}
			};
            
            // Créer le graphique
            state.charts.monthly = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: options
            });
        }

        // Fonction pour mettre à jour le graphique des top concepteurs
        function updateTopDesignersChart() {
            const ctx = document.getElementById('contributors-chart').getContext('2d');
            
            // Détruire le graphique existant s'il existe
            if (state.charts.contributors) {
                state.charts.contributors.destroy();
            }
            
            const currentData = getCurrentYearData();
            
            // Préparer les données pour les concepteurs FrontEnd
            const designersData = {};
            
            // Compter les articles par concepteur FrontEnd
            const allItems = [...currentData.nouveautes, ...currentData.evolutions, ...currentData.diversifications];
            
            allItems.forEach(item => {
                if (item.frontDesigner && item.frontDesigner.trim() !== '') {
                    if (!designersData[item.frontDesigner]) {
                        designersData[item.frontDesigner] = 0;
                    }
                    designersData[item.frontDesigner]++;
                }
            });
            
            // Trier les concepteurs par nombre d'articles
            const sortedDesigners = Object.entries(designersData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Prendre les 5 premiers
            
            // Préparer les données pour le graphique
            const labels = sortedDesigners.map(item => item[0]);
            const values = sortedDesigners.map(item => item[1]);
            
            // Données pour le graphique des concepteurs
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Nombre de cartes traitées',
                    data: values,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(255, 99, 132, 0.7)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            };
            
            // Options pour le graphique des concepteurs avec texte centré et agrandi
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
					legend: {
						display: false
					},
					datalabels: {
						display: true,
						color: 'white',
						font: {
							size: 14,
							weight: 'bold'
						},
						formatter: (value) => value,
						anchor: 'center',
						align: 'center'
					},
					// AJOUT : Désactiver les interactions de légende
					tooltip: {
						filter: function(tooltipItem) {
							return true; // Garder les tooltips actifs
						}
					}
				}
            };
            
            // Créer le graphique
            state.charts.contributors = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: options,
                plugins: [ChartDataLabels]
            });
        }

        // Fonction pour mettre à jour le graphique des top implanteurs
        function updateTopImplantersChart() {
            const ctx = document.getElementById('activity-chart').getContext('2d');
            
            // Détruire le graphique existant s'il existe
            if (state.charts.activity) {
                state.charts.activity.destroy();
            }
            
            const currentData = getCurrentYearData();
            
            // Préparer les données pour les implanteurs BackEnd
            const implantersData = {};
            
            // Compter les articles par implanteur BackEnd
            const allItems = [...currentData.nouveautes, ...currentData.evolutions, ...currentData.diversifications];
            
            allItems.forEach(item => {
                if (item.backImplanter && item.backImplanter.trim() !== '') {
                    if (!implantersData[item.backImplanter]) {
                        implantersData[item.backImplanter] = 0;
                    }
                    implantersData[item.backImplanter]++;
                }
            });
            
            // Trier les implanteurs par nombre d'articles
            const sortedImplanters = Object.entries(implantersData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Prendre les 5 premiers
            
            // Préparer les données pour le graphique
            const labels = sortedImplanters.map(item => item[0]);
            const values = sortedImplanters.map(item => item[1]);
            
            // Données pour le graphique des implanteurs
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Nombre de cartes traitées',
                    data: values,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(255, 205, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 205, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            };
            
             // Options pour le graphique des implanteurs avec texte centré et agrandi
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
					legend: {
						display: false
					},
					datalabels: {
						display: true,
						color: 'white',
						font: {
							size: 14,
							weight: 'bold'
						},
						formatter: (value) => value,
						anchor: 'center',
						align: 'center'
					},
					// AJOUT : Désactiver les interactions de légende
					tooltip: {
						filter: function(tooltipItem) {
							return true; // Garder les tooltips actifs
						}
					}
				}

            };
            
            // Créer le graphique
            state.charts.activity = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: options,
                plugins: [ChartDataLabels]
            });
        }

        // Nouvelles fonctions pour les graphiques en mode "toutes les années"
        function updateYearlyTrendsChart() {
            // Cette fonction sera implémentée pour montrer les tendances par année
            // Pour l'instant, on utilise le graphique d'activité existant
        }

        function updateAnnualComparisonChart() {
            // Cette fonction sera implémentée pour comparer les années
            // Pour l'instant, on utilise le graphique mensuel existant
        }

        function updateCumulativeChart() {
            // Cette fonction sera implémentée pour montrer l'évolution cumulative
            // Pour l'instant, on utilise le graphique de distribution existant
        }
		        // Fonction pour initialiser les paramètres
        function initSettings() {
            // Mode sombre
            document.getElementById('dark-mode-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    state.darkMode = true;
                } else {
                    document.body.classList.remove('dark-mode');
                    state.darkMode = false;
                }
                
                localStorage.setItem('darkMode', state.darkMode);
            });
            
            // Export PDF
            document.getElementById('export-pdf').addEventListener('click', exportPDF);
            
            // Export Excel
            document.getElementById('export-excel').addEventListener('click', exportExcel);
        }

        // Fonction pour exporter en PDF avec support des graphiques (VÉRIFIÉE)
        function exportPDF() {
            try {
                const { jsPDF } = window.jspdf;
                
                // Créer un nouveau document PDF
                const doc = new jsPDF();
                
                // Ajouter un titre avec l'année
                doc.setFontSize(18);
                const titleText = state.currentYear === 'all' ? 
                    'Bilan - Toutes les années' : 
                    `Bilan ${state.currentYear}`;
                doc.text(titleText, 14, 20);
                
                // Ajouter la date d'exportation
                doc.setFontSize(10);
                doc.text('Exporté le : ' + new Date().toLocaleString(), 14, 26);
                
                let currentY = 35;
                
                // Ajouter les graphiques
                currentY = addChartsToPDF(doc, currentY);
                
                // Ajouter les tableaux
                currentY = addTablesToPDF(doc, currentY);
                
                // Enregistrer le PDF
                const fileName = state.currentYear === 'all' ? 
                    'bilan_toutes_annees.pdf' : 
                    `bilan_${state.currentYear}.pdf`;
                doc.save(fileName);
                
                showToast('Export PDF réussi');
                document.getElementById('settings-popup').classList.remove('active');
            } catch (error) {
                console.error('Erreur lors de l\'export PDF:', error);
                showToast('Erreur lors de l\'export PDF');
            }
        }

        // Fonction pour ajouter les graphiques au PDF (VÉRIFIÉE)
        function addChartsToPDF(doc, startY) {
            let currentY = startY;
            
            try {
                // Ajouter le titre des graphiques
                doc.setFontSize(14);
                doc.text('Graphiques du tableau de bord', 14, currentY);
                currentY += 10;
                
                // Capturer et ajouter chaque graphique
                const chartCanvases = [
                    { id: 'distribution-chart', title: 'Répartition des articles' },
                    { id: 'monthly-chart', title: 'Articles par mois et type' },
                    { id: 'activity-chart', title: 'Top implanteurs' },
                    { id: 'contributors-chart', title: 'Top concepteurs' }
                ];
                
                chartCanvases.forEach((chartInfo, index) => {
                    const canvas = document.getElementById(chartInfo.id);
                    if (canvas) {
                        try {
                            const imgData = canvas.toDataURL('image/png');
                            
                            // Ajouter le titre du graphique
                            doc.setFontSize(12);
                            doc.text(chartInfo.title, 14, currentY);
                            currentY += 5;
                            
                            // Ajouter l'image du graphique
                            doc.addImage(imgData, 'PNG', 14, currentY, 180, 90);
                            currentY += 100;
                            
                            // Nouvelle page si nécessaire
                            if (currentY > 250 && index < chartCanvases.length - 1) {
                                doc.addPage();
                                currentY = 20;
                            }
                        } catch (chartError) {
                            console.warn(`Erreur lors de l'ajout du graphique ${chartInfo.id}:`, chartError);
                        }
                    }
                });
                
                // Nouvelle page pour les tableaux
                doc.addPage();
                currentY = 20;
                
            } catch (error) {
                console.warn('Erreur lors de l\'ajout des graphiques:', error);
            }
            
            return currentY;
        }

        // Fonction pour ajouter les tableaux au PDF (VÉRIFIÉE)
        function addTablesToPDF(doc, startY) {
            const currentData = getCurrentYearData();
            let currentY = startY;
            
            // Définir les en-têtes et colonnes
            const headers = [
                ['Date création', 'Date revue schéma', 'Date revue impl.', 'Date PLM',
                 'Nom article', 'N° article', 'Type', 'Concepteur', 'Implanteur', 'Commentaires']
            ];
            
            // Exporter les nouveautés
            if (currentData.nouveautes.length > 0) {
                doc.setFontSize(14);
                doc.text('Nouveautés', 14, currentY);
                currentY += 5;
                
                const nouveautesData = currentData.nouveautes.map(item => [
                    item.dateCreation || '',
                    item.dateSchemaReview || '',
                    item.dateImplantationReview || '',
                    item.datePLM || '',
                    item.name || '',
                    item.number || '',
                    item.type || '',
                    item.frontDesigner || '',
                    item.backImplanter || '',
                    item.comments || ''
                ]);
                
                doc.autoTable({
                    head: headers,
                    body: nouveautesData,
                    startY: currentY,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    columnStyles: { 9: { cellWidth: 30 } }
                });
                
                currentY = doc.lastAutoTable.finalY + 10;
            }
            
            // Exporter les évolutions
            if (currentData.evolutions.length > 0) {
                if (currentY > 250) {
                    doc.addPage();
                    currentY = 20;
                }
                
                doc.setFontSize(14);
                doc.text('Évolutions', 14, currentY);
                currentY += 5;
                
                const evolutionsData = currentData.evolutions.map(item => [
                    item.dateCreation || '',
                    item.dateSchemaReview || '',
                    item.dateImplantationReview || '',
                    item.datePLM || '',
                    item.name || '',
                    item.number || '',
                    item.type || '',
                    item.frontDesigner || '',
                    item.backImplanter || '',
                    item.comments || ''
                ]);
                
                doc.autoTable({
                    head: headers,
                    body: evolutionsData,
                    startY: currentY,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    columnStyles: { 9: { cellWidth: 30 } }
                });
                
                currentY = doc.lastAutoTable.finalY + 10;
            }
            
            // Exporter les diversifications
            if (currentData.diversifications.length > 0) {
                if (currentY > 250) {
                    doc.addPage();
                    currentY = 20;
                }
                
                doc.setFontSize(14);
                doc.text('Diversifications', 14, currentY);
                currentY += 5;
                
                const diversificationsData = currentData.diversifications.map(item => [
                    item.dateCreation || '',
                    item.dateSchemaReview || '',
                    item.dateImplantationReview || '',
                    item.datePLM || '',
                    item.name || '',
                    item.number || '',
                    item.type || '',
                    item.frontDesigner || '',
                    item.backImplanter || '',
                    item.comments || ''
                ]);
                
                doc.autoTable({
                    head: headers,
                    body: diversificationsData,
                    startY: currentY,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    columnStyles: { 9: { cellWidth: 30 } }
                });
            }
            
            return currentY;
        }

        // Fonction pour exporter en Excel (VÉRIFIÉE)
        function exportExcel() {
            try {
                const currentData = getCurrentYearData();
                
                // Créer un contenu CSV
                let csvContent = 'data:text/csv;charset=utf-8,';
                
                // Ajouter un en-tête avec l'année
                const yearInfo = state.currentYear === 'all' ? 'Toutes les années' : state.currentYear;
                csvContent += `Bilan - ${yearInfo}\n`;
                csvContent += `Exporté le: ${new Date().toLocaleString()}\n\n`;
                
                // Ajouter les en-têtes
                csvContent += 'Catégorie,Date création,Date revue schéma,Date revue implantation,Date PLM,Nom article,N° article,Type,Concepteur,Implanteur,Commentaires\n';
                
                // Ajouter les nouveautés
                currentData.nouveautes.forEach(item => {
                    const row = [
                        'Nouveautés',
                        item.dateCreation || '',
                        item.dateSchemaReview || '',
                        item.dateImplantationReview || '',
                        item.datePLM || '',
                        `"${(item.name || '').replace(/"/g, '""')}"`,
                        item.number || '',
                        item.type || '',
                        `"${(item.frontDesigner || '').replace(/"/g, '""')}"`,
                        `"${(item.backImplanter || '').replace(/"/g, '""')}"`,
                        `"${(item.comments || '').replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // Ajouter les évolutions
                currentData.evolutions.forEach(item => {
                    const row = [
                        'Évolutions',
                        item.dateCreation || '',
                        item.dateSchemaReview || '',
                        item.dateImplantationReview || '',
                        item.datePLM || '',
                        `"${(item.name || '').replace(/"/g, '""')}"`,
                        item.number || '',
                        item.type || '',
                        `"${(item.frontDesigner || '').replace(/"/g, '""')}"`,
                        `"${(item.backImplanter || '').replace(/"/g, '""')}"`,
                        `"${(item.comments || '').replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // Ajouter les diversifications
                currentData.diversifications.forEach(item => {
                    const row = [
                        'Diversifications',
                        item.dateCreation || '',
                        item.dateSchemaReview || '',
                        item.dateImplantationReview || '',
                        item.datePLM || '',
                        `"${(item.name || '').replace(/"/g, '""')}"`,
                        item.number || '',
                        item.type || '',
                        `"${(item.frontDesigner || '').replace(/"/g, '""')}"`,
                        `"${(item.backImplanter || '').replace(/"/g, '""')}"`,
                        `"${(item.comments || '').replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // Créer un lien pour télécharger le fichier
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                
                // Nom de fichier dynamique
                const fileName = state.currentYear === 'all' ? 
                    'bilan_toutes_annees.csv' : 
                    `bilan_${state.currentYear}.csv`;
                link.setAttribute('download', fileName);
                
                document.body.appendChild(link);
                
                // Cliquer sur le lien pour déclencher le téléchargement
                link.click();
                
                // Supprimer le lien
                document.body.removeChild(link);
                
                showToast('Export Excel réussi');
                document.getElementById('settings-popup').classList.remove('active');
            } catch (error) {
                console.error('Erreur lors de l\'export Excel:', error);
                showToast('Erreur lors de l\'export Excel');
            }
        }

        // Fonction pour initialiser le tri des tableaux
        function initTableSort() {
            const tables = ['nouveautes-table', 'evolutions-table', 'diversifications-table'];
            
            tables.forEach(tableId => {
                const table = document.getElementById(tableId);
                const headers = table.querySelectorAll('th[data-sort]');
                
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const sortColumn = header.getAttribute('data-sort');
                        
                        // Réinitialiser les classes de tri sur tous les en-têtes
                        headers.forEach(h => {
                            h.classList.remove('sort-asc', 'sort-desc');
                        });
                        
                        // Déterminer la direction de tri
                        if (state.sortColumn === sortColumn && state.sortDirection === 'asc') {
                            state.sortDirection = 'desc';
                            header.classList.add('sort-desc');
                        } else {
                            state.sortColumn = sortColumn;
                            state.sortDirection = 'asc';
                            header.classList.add('sort-asc');
                        }
                        
                        // Mettre à jour le tableau
                        const category = tableId.split('-')[0];
                        updateTable(category);
                    });
                });
            });
        }

        // Fonction pour afficher un toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Fonction pour effectuer l'import dans une année spécifique
        function performImport(jsonData, targetYear) {
            try {
                // S'assurer que l'année cible existe
                if (!state.data[targetYear]) {
                    state.data[targetYear] = {
                        nouveautes: [],
                        evolutions: [],
                        diversifications: []
                    };
                }
                
                let totalAjoutes = 0;
                
                ['nouveautes', 'evolutions', 'diversifications'].forEach(category => {
                    if (Array.isArray(jsonData[category])) {
                        jsonData[category].forEach(newItem => {
                            // Vérifier si l'élément existe déjà dans cette année
                            const alreadyExists = state.data[targetYear][category].some(existing => 
                                itemsAreEqual(existing, newItem)
                            );
                            
                            if (!alreadyExists) {
                                newItem.id = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                                newItem.createdAt = new Date().toISOString();
                                newItem.year = targetYear;
                                state.data[targetYear][category].push(newItem);
                                totalAjoutes++;
                            }
                        });
                    }
                });
                
                // Si l'année n'était pas dans la liste, l'ajouter
                if (!state.availableYears.includes(targetYear)) {
                    state.availableYears.push(targetYear);
                    state.availableYears.sort();
                    updateYearSelector();
                }
                
                saveData();
                updateAllTables();
                updateDashboard();
                
                showToast(`${totalAjoutes} élément(s) importé(s) dans l'année ${targetYear}`);
            } catch (error) {
                console.error('Erreur lors de l\'import:', error);
                showToast('Erreur lors de l\'import des données');
            }
        }

        // Fonction pour comparer deux éléments
        function itemsAreEqual(a, b) {
            return ['dateCreation', 'dateSchemaReview', 'dateImplantationReview', 'datePLM',
                    'name', 'number', 'type', 'frontDesigner', 'backImplanter', 'comments']
                .every(key => (a[key] || '') === (b[key] || ''));
        }

        // Fonction pour préparer le popup d'import
        function prepareImportPopup() {
            const importYearSelect = document.getElementById('import-year-select');
            const availableYearsList = document.getElementById('available-years-list');
            
            // Vider et remplir le sélecteur
            importYearSelect.innerHTML = '';
            
            // Ajouter les années existantes
            state.availableYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === state.currentYear && state.currentYear !== 'all') {
                    option.selected = true;
                }
                importYearSelect.appendChild(option);
            });
            
            // Mettre à jour la liste des années disponibles
            availableYearsList.textContent = state.availableYears.join(', ');
        }
    </script>

<script>
        // Gestion de l'export JSON automatique (modifié)
        document.addEventListener('DOMContentLoaded', () => {
            const exportBtn = document.getElementById('export-json-button');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    // Export automatique de toutes les années sans question
                    const exportData = {
                        metadata: {
                            exportDate: new Date().toISOString(),
                            exportType: 'all_years',
                            availableYears: state.availableYears
                        },
                        data: state.data
                    };
                    
                    const fileName = `export_complet_${new Date().toISOString().split('T')[0]}.json`;
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    // Mettre à jour la date de dernière sauvegarde JSON
                    const timestamp = Date.now();
                    localStorage.setItem('lastJsonExportTime', timestamp);
                    document.getElementById('last-save-time').textContent = new Date(timestamp).toLocaleString();

                    showToast(`Export JSON complet effectué: ${fileName}`);
                });
            }
        });
    </script>

<script>
        // Gestion de l'import JSON avec confirmation d'année (modifié)
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('import-json-file');
            const button = document.getElementById('import-json-button');

            if (button && input) {
                button.addEventListener('click', () => input.click());

                input.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const content = await file.text();
                    let jsonData;
                    try {
                        jsonData = JSON.parse(content);
                    } catch (e) {
                        showToast("Erreur de lecture du fichier JSON");
                        return;
                    }

                    // Vérifier le type d'export
                    if (jsonData.metadata && jsonData.metadata.exportType === 'all_years') {
                        // Import de toutes les années
                        if (confirm('Ce fichier contient des données pour plusieurs années. Voulez-vous les importer toutes ?')) {
                            try {
                                Object.keys(jsonData.data).forEach(year => {
                                    if (!state.availableYears.includes(year)) {
                                        state.availableYears.push(year);
                                    }
                                    state.data[year] = jsonData.data[year];
                                });
                                
                                state.availableYears.sort();
                                updateYearSelector();
                                saveData();
                                updateAllTables();
                                updateDashboard();
                                
                                showToast('Import multi-années effectué avec succès');
                            } catch (error) {
                                console.error('Erreur lors de l\'import multi-années:', error);
                                showToast('Erreur lors de l\'import multi-années');
                            }
                        }
                    } else {
                        // Import pour une année spécifique - demander confirmation avec l'année courante
                        const currentDisplayYear = state.currentYear === 'all' ? state.availableYears[state.availableYears.length - 1] : state.currentYear;
                        
                        if (confirm(`Import pour l'année ${currentDisplayYear} ?`)) {
                            try {
                                performImport(jsonData, currentDisplayYear);
                            } catch (error) {
                                console.error('Erreur lors de l\'import:', error);
                                showToast('Erreur lors de l\'import des données');
                            }
                        }
                    }

                    // Réinitialiser l'input
                    input.value = '';
                });
            }
        });
    </script>
</body>
</html>
